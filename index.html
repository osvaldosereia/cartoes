<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Clientes (Cards)</title>
    <!-- Carrega o Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Biblioteca de ícones (Lucide) -->
    <script src="https://unpkg.com/lucide-react@0.395.0/dist/umd/lucide.min.js"></script>
    <style>
        /* Estilo para a fonte Inter */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Ajuste para inputs de número sem setas (spinners) */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
        /* Para animação de 'hidden' */
        .extrato-lista {
            transition: all 0.3s ease-in-out;
            overflow: hidden;
            max-height: 0;
            opacity: 0;
        }
        .extrato-lista.visible {
            max-height: 1000px; /* altura suficiente */
            opacity: 1;
            margin-top: 1rem;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-900 antialiased">

    <!-- Container Principal -->
    <div class="container mx-auto max-w-7xl p-4 sm:p-6 lg:p-8">

        <h1 class="text-3xl font-bold text-gray-800 mb-6">Gestor de Clientes</h1>

        <!-- Seção de Estatísticas (Cabeçalho) -->
        <div id="stats-header" class="mb-6 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
            <!-- Cards de Estatísticas serão injetados aqui -->
        </div>

        <!-- Seção de Controles (Busca, Import/Export, Novo Cliente) -->
        <div class="mb-6 flex flex-col md:flex-row justify-between items-center gap-4">
            <!-- Barra de Busca -->
            <div class="relative w-full md:max-w-xs">
                <input 
                    type="text" 
                    id="search-input" 
                    placeholder="Buscar cliente por nome..."
                    class="w-full pl-10 pr-4 py-2 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                >
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <i data-lucide="search" class="w-5 h-5 text-gray-400"></i>
                </div>
            </div>
            
            <!-- Grupo de Botões -->
            <div class="flex flex-col sm:flex-row gap-3 w-full md:w-auto">
                 <!-- Botões Import/Export -->
                <input type="file" id="import-file-input" class="hidden" accept=".json" onchange="handleFileSelect(event)">
                <button 
                    id="import-button"
                    class="w-full sm:w-auto inline-flex justify-center rounded-md border border-gray-300 bg-white py-2 px-4 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
                >
                    <i data-lucide="upload" class="w-5 h-5 mr-2"></i>
                    Importar
                </button>
                <button 
                    id="export-button"
                    class="w-full sm:w-auto inline-flex justify-center rounded-md border border-gray-300 bg-white py-2 px-4 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
                >
                    <i data-lucide="download" class="w-5 h-5 mr-2"></i>
                    Exportar
                </button>

                <!-- Botão Novo Cliente -->
                <button 
                    id="show-novo-cliente-modal"
                    class="w-full sm:w-auto inline-flex justify-center rounded-md border border-transparent bg-blue-600 py-2 px-4 text-sm font-medium text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
                >
                    <i data-lucide="user-plus" class="w-5 h-5 mr-2"></i>
                    Novo Cliente
                </button>
            </div>
        </div>
        
        <!-- Seção de Filtros (Segmentadores) -->
        <div id="filters-container" class="mb-6 flex flex-col sm:flex-row flex-wrap gap-4 p-4 bg-white rounded-lg shadow">
            <h3 class="text-lg font-medium text-gray-800 sm:self-center w-full sm:w-auto mb-2 sm:mb-0">Filtros:</h3>
            
            <!-- Filtro por Bandeira -->
            <div class="flex-1 min-w-[150px]">
                <label for="filtro-bandeira" class="block text-sm font-medium text-gray-700">Bandeira</label>
                <select id="filtro-bandeira" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    <option value="">Todas</option>
                    <option value="ALELO">ALELO</option>
                    <option value="SODEXO/PLUXEE">SODEXO/PLUXEE</option>
                    <option value="VR">VR</option>
                    <option value="CABAL">CABAL</option>
                    <option value="TICKET">TICKET</option>
                    <option value="R6">R6</option>
                    <option value="FLASH">FLASH</option>
                    <option value="IFOOD">IFOOD</option>
                    <option value="HEINEKEN">HEINEKEN</option>
                    <option value="Outra">Outra</option>
                </select>
            </div>
            
            <!-- Filtro por Vendedor -->
            <div class="flex-1 min-w-[150px]">
                <label for="filtro-vendedor" class="block text-sm font-medium text-gray-700">Vendedor</label>
                <select id="filtro-vendedor" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    <option value="">Todos</option>
                    <option value="Osvaldo">Osvaldo</option>
                    <option value="Lucas">Lucas</option>
                    <option value="Claudenil">Claudenil</option>
                    <option value="Outro">Outro</option>
                </select>
            </div>

            <!-- Filtro de Ordenação -->
            <div class="flex-1 min-w-[150px]">
                <label for="filtro-ordenacao" class="block text-sm font-medium text-gray-700">Ordenar por</label>
                <select id="filtro-ordenacao" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    <option value="nome">Nome (A-Z)</option>
                    <option value="empresa">Empresa (A-Z)</option>
                    <option value="saldoDesc">Saldo (Maior)</option>
                    <option value="saldoAsc">Saldo (Menor)</option>
                    <option value="comissaoDesc">Comissão (Maior)</option>
                    <option value="comissaoAsc">Comissão (Menor)</option>
                </select>
            </div>
        </div>


        <!-- Seção de Cards de Clientes -->
        <div id="client-cards-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Cards de clientes serão injetados aqui -->
            <p class="text-gray-500 col-span-full text-center" id="loading-message">Carregando dados...</p>
        </div>
        
    </div> <!-- Fim do Container Principal -->
    
    <!-- Notificação de "Salvo" -->
    <div id="save-toast" class="fixed bottom-4 right-4 z-[100] bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg opacity-0 transition-opacity duration-300 pointer-events-none">
        <i data-lucide="check-circle" class="inline-block w-5 h-5 mr-2"></i>
        Salvo com sucesso!
    </div>

    <!-- Modal: Novo Cliente -->
    <div id="novo-cliente-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden overflow-y-auto">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg m-4 transform transition-all">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-semibold text-gray-800">Cadastrar Novo Cliente</h2>
                <button id="close-novo-cliente-modal" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <form id="novo-cliente-form" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <!-- Coluna 1 -->
                <div>
                    <label for="nome" class="block text-sm font-medium text-gray-700">Nome *</label>
                    <input type="text" id="nome" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
                <div>
                    <label for="telefone" class="block text-sm font-medium text-gray-700">Telefone</label>
                    <input type="tel" id="telefone" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
                <div>
                    <label for="empresa" class="block text-sm font-medium text-gray-700">Empresa</label>
                    <input type="text" id="empresa" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
                 <div>
                    <label for="senha" class="block text-sm font-medium text-gray-700">Senha</label>
                    <input type="text" id="senha" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
                
                <!-- Coluna 2 -->
                <div>
                    <label for="bandeira" class="block text-sm font-medium text-gray-700">Bandeira</label>
                    <select id="bandeira" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <option value="">Selecione...</option>
                        <option value="ALELO">ALELO</option>
                        <option value="SODEXO/PLUXEE">SODEXO/PLUXEE</option>
                        <option value="VR">VR</option>
                        <option value="CABAL">CABAL</option>
                        <option value="TICKET">TICKET</option>
                        <option value="R6">R6</option>
                        <option value="FLASH">FLASH</option>
                        <option value="IFOOD">IFOOD</option>
                        <option value="HEINEKEN">HEINEKEN</option>
                        <option value="Outra">Outra</option>
                    </select>
                </div>
                <div>
                    <label for="vendedor" class="block text-sm font-medium text-gray-700">Vendedor</label>
                    <select id="vendedor" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <option value="">Selecione...</option>
                        <option value="Osvaldo">Osvaldo</option>
                        <option value="Lucas">Lucas</option>
                        <option value="Claudenil">Claudenil</option>
                        <option value="Outro">Outro</option>
                    </select>
                </div>
                <div>
                    <label for="percentualComissao" class="block text-sm font-medium text-gray-700">% Comissão *</label>
                    <input type="number" id="percentualComissao" step="0.01" min="0" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" placeholder="Ex: 10.5">
                </div>
                <div>
                    <label for="saldoInicial" class="block text-sm font-medium text-gray-700">Saldo Inicial (R$)</label>
                    <input type="number" id="saldoInicial" step="0.01" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" placeholder="Opcional. Ex: 150.00">
                </div>
                
                <!-- Novos campos de Pix -->
                <div class="col-span-full sm:col-span-1">
                    <label for="tipoPix" class="block text-sm font-medium text-gray-700">Tipo Chave Pix</label>
                    <select id="tipoPix" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <option value="">Nenhuma</option>
                        <option value="celular">Celular</option>
                        <option value="cpf_cnpj">CPF/CNPJ</option>
                        <option value="email">Email</option>
                        <option value="aleatoria">Aleatória</option>
                    </select>
                </div>
                <div class="col-span-full sm:col-span-1">
                    <label for="chavePix" class="block text-sm font-medium text-gray-700">Chave Pix</label>
                    <input type="text" id="chavePix" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>

                <!-- Novos campos de Endereço -->
                <div class="col-span-full">
                    <h3 class="text-md font-medium text-gray-700 mt-4 border-t pt-4">Endereço</h3>
                </div>

                <div class="col-span-full sm:col-span-1">
                    <label for="cep" class="block text-sm font-medium text-gray-700">CEP</label>
                    <input type="text" id="cep" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
                <div class="col-span-full sm:col-span-1">
                    <label for="logradouro" class="block text-sm font-medium text-gray-700">Logradouro</label>
                    <input type="text" id="logradouro" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
                <div class="col-span-full sm:col-span-1">
                    <label for="numero" class="block text-sm font-medium text-gray-700">Número</label>
                    <input type="text" id="numero" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
                <div class="col-span-full sm:col-span-1">
                    <label for="complemento" class="block text-sm font-medium text-gray-700">Complemento</label>
                    <input type="text" id="complemento" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
                <div class="col-span-full sm:col-span-1">
                    <label for="bairro" class="block text-sm font-medium text-gray-700">Bairro</label>
                    <input type="text" id="bairro" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
                <div class="col-span-full sm:col-span-1">
                    <label for="cidade" class="block text-sm font-medium text-gray-700">Cidade</label>
                    <input type="text" id="cidade" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
                <div class="col-span-full sm:col-span-1">
                    <label for="estado" class="block text-sm font-medium text-gray-700">Estado</label>
                    <input type="text" id="estado" maxlength="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" placeholder="Ex: SP">
                </div>

                <!-- Botão de Envio -->
                <div class="col-span-full flex justify-end mt-4">
                    <button type="submit" class="inline-flex justify-center rounded-md border border-transparent bg-blue-600 py-2 px-4 text-sm font-medium text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                        Salvar Cliente
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal: EDITAR Cliente (NOVO) -->
    <div id="edit-cliente-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden overflow-y-auto">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg m-4 transform transition-all">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-semibold text-gray-800">Editar Cliente</h2>
                <button id="close-edit-cliente-modal" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <!-- O formulário é idêntico ao de novo cliente, mas com IDs diferentes para os campos -->
            <form id="edit-cliente-form" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <input type="hidden" id="edit-cliente-id">
                
                <!-- Coluna 1 -->
                <div>
                    <label for="edit-nome" class="block text-sm font-medium text-gray-700">Nome *</label>
                    <input type="text" id="edit-nome" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
                <div>
                    <label for="edit-telefone" class="block text-sm font-medium text-gray-700">Telefone</label>
                    <input type="tel" id="edit-telefone" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
                <div>
                    <label for="edit-empresa" class="block text-sm font-medium text-gray-700">Empresa</label>
                    <input type="text" id="edit-empresa" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
                 <div>
                    <label for="edit-senha" class="block text-sm font-medium text-gray-700">Senha</label>
                    <input type="text" id="edit-senha" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
                
                <!-- Coluna 2 -->
                <div>
                    <label for="edit-bandeira" class="block text-sm font-medium text-gray-700">Bandeira</label>
                    <select id="edit-bandeira" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <option value="">Selecione...</option>
                        <option value="ALELO">ALELO</option>
                        <option value="SODEXO/PLUXEE">SODEXO/PLUXEE</option>
                        <option value="VR">VR</option>
                        <option value="CABAL">CABAL</option>
                        <option value="TICKET">TICKET</option>
                        <option value="R6">R6</option>
                        <option value="FLASH">FLASH</option>
                        <option value="IFOOD">IFOOD</option>
                        <option value="HEINEKEN">HEINEKEN</option>
                        <option value="Outra">Outra</option>
                    </select>
                </div>
                <div>
                    <label for="edit-vendedor" class="block text-sm font-medium text-gray-700">Vendedor</label>
                    <select id="edit-vendedor" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <option value="">Selecione...</option>
                        <option value="Osvaldo">Osvaldo</option>
                        <option value="Lucas">Lucas</option>
                        <option value="Claudenil">Claudenil</option>
                        <option value="Outro">Outro</option>
                    </select>
                </div>
                <div>
                    <label for="edit-percentualComissao" class="block text-sm font-medium text-gray-700">% Comissão *</label>
                    <input type="number" id="edit-percentualComissao" step="0.01" min="0" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" placeholder="Ex: 10.5">
                </div>
                <div>
                    <label for="edit-saldoInicial" class="block text-sm font-medium text-gray-700">Saldo Inicial (R$)</label>
                    <input type="number" id="edit-saldoInicial" step="0.01" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" placeholder="Opcional. Ex: 150.00">
                </div>
                
                <!-- Campos de Pix -->
                <div class="col-span-full sm:col-span-1">
                    <label for="edit-tipoPix" class="block text-sm font-medium text-gray-700">Tipo Chave Pix</label>
                    <select id="edit-tipoPix" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <option value="">Nenhuma</option>
                        <option value="celular">Celular</option>
                        <option value="cpf_cnpj">CPF/CNPJ</option>
                        <option value="email">Email</option>
                        <option value="aleatoria">Aleatória</option>
                    </select>
                </div>
                <div class="col-span-full sm:col-span-1">
                    <label for="edit-chavePix" class="block text-sm font-medium text-gray-700">Chave Pix</label>
                    <input type="text" id="edit-chavePix" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>

                <!-- Campos de Endereço -->
                <div class="col-span-full">
                    <h3 class="text-md font-medium text-gray-700 mt-4 border-t pt-4">Endereço</h3>
                </div>

                <div class="col-span-full sm:col-span-1">
                    <label for="edit-cep" class="block text-sm font-medium text-gray-700">CEP</label>
                    <input type="text" id="edit-cep" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
                <div class="col-span-full sm:col-span-1">
                    <label for="edit-logradouro" class="block text-sm font-medium text-gray-700">Logradouro</label>
                    <input type="text" id="edit-logradouro" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
                <div class="col-span-full sm:col-span-1">
                    <label for="edit-numero" class="block text-sm font-medium text-gray-700">Número</label>
                    <input type="text" id="edit-numero" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
                <div class="col-span-full sm:col-span-1">
                    <label for="edit-complemento" class="block text-sm font-medium text-gray-700">Complemento</label>
                    <input type="text" id="edit-complemento" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
                <div class="col-span-full sm:col-span-1">
                    <label for="edit-bairro" class="block text-sm font-medium text-gray-700">Bairro</label>
                    <input type="text" id="edit-bairro" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
                <div class="col-span-full sm:col-span-1">
                    <label for="edit-cidade" class="block text-sm font-medium text-gray-700">Cidade</label>
                    <input type="text" id="edit-cidade" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
                <div class="col-span-full sm:col-span-1">
                    <label for="edit-estado" class="block text-sm font-medium text-gray-700">Estado</label>
                    <input type="text" id="edit-estado" maxlength="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" placeholder="Ex: SP">
                </div>

                <!-- Botão de Envio -->
                <div class="col-span-full flex justify-end mt-4">
                    <button type="submit" class="inline-flex justify-center rounded-md border border-transparent bg-blue-600 py-2 px-4 text-sm font-medium text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                        Atualizar Cliente
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal: Nova Transação -->
    <div id="nova-transacao-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md m-4 transform transition-all">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-semibold text-gray-800">Nova Transação</h2>
                <button id="close-nova-transacao-modal" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <form id="nova-transacao-form" class="space-y-4">
                <input type="hidden" id="transacao-cliente-id">
                <p class="text-sm text-gray-600">Adicionando para: <strong id="transacao-cliente-nome" class="text-gray-800">...</strong></p>
                
                <div>
                    <label for="transacao-tipo" class="block text-sm font-medium text-gray-700">Tipo *</label>
                    <select id="transacao-tipo" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <option value="entrada">Entrada (Crédito)</option>
                        <option value="saida">Saída (Uso)</option>
                    </select>
                </div>
                
                <div id="loja-input-container" class="hidden"> <!-- Campo Loja (inicia oculto) -->
                    <label for="transacao-loja" class="block text-sm font-medium text-gray-700">Loja *</label>
                    <input type="text" id="transacao-loja" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
                
                <div>
                    <label for="transacao-data" class="block text-sm font-medium text-gray-700">Data *</label>
                    <input type="date" id="transacao-data" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
                
                <div>
                    <label for="transacao-valor" class="block text-sm font-medium text-gray-700">Valor (R$) *</label>
                    <input type="number" id="transacao-valor" step="0.01" min="0" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>

                <div class="flex justify-end mt-4">
                    <button type="submit" class="inline-flex justify-center rounded-md border border-transparent bg-blue-600 py-2 px-4 text-sm font-medium text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                        Salvar Transação
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: EDITAR Transação (NOVO) -->
    <div id="edit-transacao-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md m-4 transform transition-all">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-semibold text-gray-800">Editar Transação</h2>
                <button id="close-edit-transacao-modal" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <form id="edit-transacao-form" class="space-y-4">
                <input type="hidden" id="edit-transacao-cliente-id">
                <input type="hidden" id="edit-transacao-id">
                
                <div>
                    <label for="edit-transacao-tipo" class="block text-sm font-medium text-gray-700">Tipo *</label>
                    <select id="edit-transacao-tipo" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <option value="entrada">Entrada (Crédito)</option>
                        <option value="saida">Saída (Uso)</option>
                    </select>
                </div>
                
                <div id="edit-loja-input-container" class="hidden"> <!-- Campo Loja (inicia oculto) -->
                    <label for="edit-transacao-loja" class="block text-sm font-medium text-gray-700">Loja *</label>
                    <input type="text" id="edit-transacao-loja" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
                
                <div>
                    <label for="edit-transacao-data" class="block text-sm font-medium text-gray-700">Data *</label>
                    <input type="date" id="edit-transacao-data" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
                
                <div>
                    <label for="edit-transacao-valor" class="block text-sm font-medium text-gray-700">Valor (R$) *</label>
                    <input type="number" id="edit-transacao-valor" step="0.01" min="0" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>

                <div class="flex justify-end mt-4">
                    <button type="submit" class="inline-flex justify-center rounded-md border border-transparent bg-blue-600 py-2 px-4 text-sm font-medium text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                        Atualizar Transação
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Opções WhatsApp -->
    <div id="whatsapp-options-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm m-4 transform transition-all">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-semibold text-gray-800">WhatsApp para <span id="whatsapp-cliente-nome" class="font-bold">...</span></h2>
                <button id="close-whatsapp-options-modal" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div class="space-y-3">
                <p class="text-sm text-gray-600">Selecione uma mensagem pré-definida para enviar.</p>
                <button 
                    id="btn-whatsapp-extrato"
                    class="w-full inline-flex justify-center items-center rounded-md border border-gray-300 bg-white py-2 px-4 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50"
                >
                    <i data-lucide="list-check" class="w-5 h-5 mr-2"></i>
                    Pedir print do extrato
                </button>
                <button 
                    id="btn-whatsapp-pix"
                    class="w-full inline-flex justify-center items-center rounded-md border border-gray-300 bg-white py-2 px-4 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50"
                >
                    <i data-lucide="key-round" class="w-5 h-5 mr-2"></i>
                    Confirmar dados do Pix
                </button>
            </div>
        </div>
    </div>


    <!-- Scripts (Não é mais Firebase) -->
    <script>
        
        // --- Constantes de Storage ---
        const CLIENTES_STORAGE_KEY = 'gestor_clientes_data';
        const TRANSACOES_STORAGE_KEY = 'gestor_transacoes_data';

        // --- Estado da Aplicação ---
        let clientes = []; // Array de clientes
        let transacoes = new Map(); // Map(clienteId -> [array de transacoes])
        let searchQuery = ""; // Estado da busca
        let filtroBandeira = ""; // Estado do filtro de bandeira
        let filtroVendedor = ""; // Estado do filtro de vendedor
        let criterioOrdenacao = "nome"; // Estado da ordenação

        // --- Inicialização ---

        function initApp() {
            console.log("Inicializando aplicação com localStorage.");
            loadData();
            // Adiciona listeners aos filtros
            document.getElementById('search-input').addEventListener('input', handleSearch);
            document.getElementById('filtro-bandeira').addEventListener('change', handleFiltroBandeira);
            document.getElementById('filtro-vendedor').addEventListener('change', handleFiltroVendedor);
            document.getElementById('filtro-ordenacao').addEventListener('change', handleFiltroOrdenacao);
            
            render();
        }

        // --- Persistência (localStorage) ---

        function loadData() {
            try {
                const clientesData = localStorage.getItem(CLIENTES_STORAGE_KEY);
                const transacoesData = localStorage.getItem(TRANSACOES_STORAGE_KEY);
                
                if (clientesData) {
                    clientes = JSON.parse(clientesData);
                } else {
                    clientes = [];
                }
                
                if (transacoesData) {
                    // Converte o array salvo de volta para um Map
                    transacoes = new Map(JSON.parse(transacoesData));
                } else {
                    transacoes = new Map();
                }
                
                console.log(`Carregados ${clientes.length} clientes e ${transacoes.size} registros de transação.`);

            } catch (error) {
                console.error("Erro ao carregar dados do localStorage:", error);
                clientes = [];
                transacoes = new Map();
                // Mostra um erro para o usuário caso o JSON esteja corrompido
                showErrorModal("Houve um erro ao carregar seus dados. Pode ser necessário limpar o cache do navegador ou importar um backup.");
            }
        }
        
        let toastTimeout;
        function showSaveToast() {
            const toast = document.getElementById('save-toast');
            if (!toast) return;
            
            // Limpa timeout anterior se houver
            if (toastTimeout) clearTimeout(toastTimeout);
            
            toast.classList.remove('opacity-0');
            toast.classList.add('opacity-100');
            
            // Recria o ícone no toast
            if (window.lucide) {
                window.lucide.createIcons();
            }
            
            toastTimeout = setTimeout(() => {
                toast.classList.remove('opacity-100');
                toast.classList.add('opacity-0');
            }, 2000); // Mostra por 2 segundos
        }
        
        function saveData() {
            try {
                // Salva clientes como string JSON
                localStorage.setItem(CLIENTES_STORAGE_KEY, JSON.stringify(clientes));
                
                // Converte o Map de transações para um array [key, value] e salva como string JSON
                localStorage.setItem(TRANSACOES_STORAGE_KEY, JSON.stringify(Array.from(transacoes.entries())));
                
                console.log("Dados salvos no localStorage.");
                showSaveToast(); // Mostra a notificação de "Salvo"
            } catch (error) {
                console.error("Erro ao salvar dados no localStorage:", error);
                showErrorModal("Erro ao salvar dados. O armazenamento local pode estar cheio.");
            }
        }
        
        // --- Renderização (Atualização da UI) ---

        function render() {
            console.log(`Renderizando com filtros: Nome='${searchQuery}', Bandeira='${filtroBandeira}', Vendedor='${filtroVendedor}', Ordem='${criterioOrdenacao}'`);
            
            // 1. Filtrar
            const filteredClientes = clientes.filter(c => {
                const matchNome = c.nome.toLowerCase().includes(searchQuery.toLowerCase());
                const matchBandeira = (filtroBandeira === '') || (c.bandeira === filtroBandeira);
                const matchVendedor = (filtroVendedor === '') || (c.vendedor === filtroVendedor);
                return matchNome && matchBandeira && matchVendedor;
            });

            // 2. Renderizar Estatísticas (COM BASE NOS FILTROS)
            renderEstatisticas(filteredClientes);
            
            // 3. Ordenar (COM BASE NOS FILTROS)
            filteredClientes.sort((a, b) => {
                switch (criterioOrdenacao) {
                    case 'nome':
                        return a.nome.localeCompare(b.nome);
                    case 'empresa':
                        // Tratar valores nulos ou vazios
                        return (a.empresa || '').localeCompare(b.empresa || '');
                    case 'saldoDesc':
                        return calculateClientStats(b.id).saldoAtual - calculateClientStats(a.id).saldoAtual;
                    case 'saldoAsc':
                        return calculateClientStats(a.id).saldoAtual - calculateClientStats(b.id).saldoAtual;
                    case 'comissaoDesc':
                        return calculateClientStats(b.id).totalComissao - calculateClientStats(a.id).totalComissao;
                    case 'comissaoAsc':
                        return calculateClientStats(a.id).totalComissao - calculateClientStats(b.id).totalComissao;
                    default:
                        return a.nome.localeCompare(b.nome);
                }
            });

            // 4. Renderizar Cards (COM BASE NOS FILTROS E ORDEM)
            renderClientCards(filteredClientes);
            
            // Recria os ícones
            if (window.lucide) {
                window.lucide.createIcons();
            }
        }

        function calculateAllStats(clientesParaCalcular) {
            let totalSaldo = 0;
            let totalComissao = 0;
            
            for (const cliente of clientesParaCalcular) {
                const stats = calculateClientStats(cliente.id);
                totalSaldo += stats.saldoAtual;
                totalComissao += stats.totalComissao;
            }
            
            return {
                totalSaldo,
                totalComissao,
                qtdClientes: clientesParaCalcular.length
            };
        }
        
        function calculateClientStats(clienteId) {
            const cliente = clientes.find(c => c.id === clienteId);
            const txs = transacoes.get(clienteId) || [];
            
            let totalEntradas = 0;
            let totalSaidas = 0;
            let totalComissao = 0;
            const saldoInicial = cliente ? (cliente.saldoInicial || 0) : 0; // Pega o saldo inicial
            const percentualComissao = cliente ? (cliente.percentualComissao || 0) / 100 : 0;
            
            txs.forEach(t => {
                const valor = t.valor || 0;
                if (t.tipo === 'entrada') {
                    totalEntradas += valor;
                    totalComissao += valor * percentualComissao;
                } else if (t.tipo === 'saida') {
                    totalSaidas += valor;
                }
            });
            
            const saldoAtual = saldoInicial + totalEntradas - totalSaidas; // Ajusta o cálculo do saldo
            return { saldoAtual, totalComissao, totalEntradas, totalSaidas };
        }
        
        function renderEstatisticas(clientesParaCalcular) {
            const statsContainer = document.getElementById('stats-header');
            // Calcula stats com base na lista filtrada
            const { totalSaldo, totalComissao, qtdClientes } = calculateAllStats(clientesParaCalcular);

            statsContainer.innerHTML = `
                <div class="bg-white p-4 rounded-lg shadow-md">
                    <h3 class="text-sm font-medium text-gray-500 truncate">Qtd. Clientes (Filtro)</h3>
                    <p class="mt-1 text-3xl font-semibold text-gray-900">${qtdClientes}</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-md">
                    <h3 class="text-sm font-medium text-gray-500 truncate">Saldo Total (Filtro)</h3>
                    <p class="mt-1 text-3xl font-semibold text-gray-900">${formatCurrency(totalSaldo)}</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-md">
                    <h3 class="text-sm font-medium text-gray-500 truncate">Total Comissões (Filtro)</h3>
                    <p class="mt-1 text-3xl font-semibold text-gray-900">${formatCurrency(totalComissao)}</p>
                </div>
            `;
        }
        
        function renderClientCards(filteredClientes) {
            const container = document.getElementById('client-cards-container');
            const loadingMsg = document.getElementById('loading-message');
            
            // A lógica de filtragem e ordenação foi movida para a função render()
            
            console.log(`Exibindo ${filteredClientes.length} de ${clientes.length} clientes ordenados por ${criterioOrdenacao}.`);
            
            if (filteredClientes.length === 0) {
                loadingMsg.textContent = (searchQuery || filtroBandeira || filtroVendedor) 
                    ? 'Nenhum cliente encontrado com os filtros aplicados.' 
                    : 'Nenhum cliente cadastrado.';
                loadingMsg.classList.remove('hidden');
                container.innerHTML = '';
            } else {
                loadingMsg.classList.add('hidden');
                container.innerHTML = filteredClientes.map(cliente => {
                    const { saldoAtual, totalComissao } = calculateClientStats(cliente.id);
                    const txs = transacoes.get(cliente.id) || [];
                    
                    // Ordena transações por data (mais recente primeiro) para o extrato
                    txs.sort((a, b) => (b.data || '').localeCompare(a.data || ''));
                    
                    const saldoColor = saldoAtual > 0 ? 'text-green-600' : (saldoAtual < 0 ? 'text-red-600' : 'text-gray-900');
                    
                    return `
                    <div class="bg-white shadow-lg rounded-lg p-5 flex flex-col justify-between">
                        <div>
                            <!-- Informações do Cliente -->
                            <div class="flex justify-between items-start mb-3">
                                <div>
                                    <h3 class="text-xl font-bold text-gray-800">${cliente.nome}</h3>
                                    <p class="text-sm text-gray-500">${cliente.empresa || 'Sem empresa'}</p>
                                    <p class="text-sm text-gray-500">${cliente.telefone || 'Sem telefone'}</p>
                                    <p class="text-sm text-gray-500">Vendedor: <span class="font-medium text-gray-700">${cliente.vendedor || 'N/A'}</span></p>
                                    <p class="text-sm text-gray-500">Senha: <span class="font-medium text-gray-700">${cliente.senha || 'N/A'}</span></p>
                                </div>
                                <div class="flex flex-col gap-2"> <!-- Container para ícones -->
                                    <button onclick="showWhatsAppModal('${cliente.id}')" class="text-gray-400 hover:text-green-600" title="Enviar WhatsApp">
                                        <i data-lucide="message-circle" class="w-5 h-5"></i>
                                    </button>
                                    <button onclick="showEditClienteModal('${cliente.id}')" class="text-gray-400 hover:text-blue-600" title="Editar Cliente">
                                        <i data-lucide="file-edit" class="w-5 h-5"></i>
                                    </button>
                                    <button onclick="deleteClienteLocal('${cliente.id}', '${cliente.nome}')" class="text-gray-400 hover:text-red-600" title="Excluir Cliente">
                                        <i data-lucide="trash-2" class="w-5 h-5"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Stats do Cliente -->
                            <div class="mb-4">
                                <p class="text-sm font-medium text-gray-500">% Comissão</p>
                                <p class="text-lg font-semibold text-blue-600">${formatPercentage(cliente.percentualComissao)}</p>
                            </div>
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div>
                                    <p class="text-sm font-medium text-gray-500">Saldo Atual</p>
                                    <p class="text-2xl font-bold ${saldoColor}">${formatCurrency(saldoAtual)}</p>
                                </div>
                                <div>
                                    <p class="text-sm font-medium text-gray-500">Comissão Gerada</p>
                                    <p class="text-lg font-semibold text-gray-800">${formatCurrency(totalComissao)}</p>
                                </div>
                            </div>
                            
                            <!-- Botões de Ação do Card -->
                            <div class="flex flex-col sm:flex-row gap-3 mb-4">
                                <button 
                                    onclick="showTransactionModal('${cliente.id}', '${cliente.nome}')"
                                    class="flex-1 inline-flex justify-center items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
                                >
                                    <i data-lucide="dollar-sign" class="w-4 h-4 mr-2"></i>
                                    Nova Transação
                                </button>
                                <button 
                                    onclick="toggleTransactions('${cliente.id}')"
                                    class="flex-1 inline-flex justify-center items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md shadow-sm text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
                                >
                                    <i data-lucide="list" class="w-4 h-4 mr-2"></i>
                                    Ver Extrato (${txs.length})
                                </button>
                            </div>
                            
                            <!-- Lista de Transações (Extrato) - Oculta por padrão -->
                            <div id="extrato-lista-${cliente.id}" class="extrato-lista">
                                <h4 class="text-md font-semibold mb-2 text-gray-700">Últimas Transações</h4>
                                
                                <button 
                                    onclick="exportarExtratoCSV('${cliente.id}', '${cliente.nome}')"
                                    class="w-full inline-flex justify-center items-center px-3 py-1.5 border border-gray-300 text-xs font-medium rounded-md shadow-sm text-gray-700 bg-white hover:bg-gray-50 mb-3"
                                >
                                    <i data-lucide="file-spreadsheet" class="w-4 h-4 mr-2"></i>
                                    Exportar Extrato (CSV)
                                </button>

                                <div class="border rounded-md divide-y divide-gray-200">
                                    ${renderTransactions(txs, cliente.id)}
                                </div>
                            </div>
                            
                        </div>
                    </div>
                    `;
                }).join('');
            }
        }
        
        function renderTransactions(txs, clienteId) {
            if (txs.length === 0) {
                return '<p class="text-sm text-gray-500 p-3 text-center">Nenhuma transação registrada.</p>';
            }
            
            return txs.map(t => {
                const isEntrada = t.tipo === 'entrada';
                const icon = isEntrada ? 'arrow-up-circle' : 'arrow-down-circle';
                const color = isEntrada ? 'text-green-600' : 'text-red-600';
                const sign = isEntrada ? '+' : '-';
                
                return `
                <div class="p-3 flex justify-between items-center hover:bg-gray-50">
                    <div class="flex items-center gap-3">
                        <i data-lucide="${icon}" class="w-5 h-5 ${color}"></i>
                        <div>
                            <p class="text-sm font-medium ${color}">${isEntrada ? 'Entrada' : 'Saída'}</p>
                            <p class="text-xs text-gray-500">${formatDate(t.data)}</p>
                            ${t.tipo === 'saida' && t.loja ? `<p class="text-xs text-gray-500">Loja: ${t.loja}</p>` : ''}
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-sm font-semibold ${color}">${sign} ${formatCurrency(t.valor)}</p>
                        <div class="flex gap-2 justify-end">
                            <button onclick="showEditTransacaoModal('${clienteId}', '${t.id}')" class="text-gray-400 hover:text-blue-600 text-xs" title="Editar Transação">
                               <i data-lucide="edit-3" class="w-3 h-3"></i>
                            </button> <!-- CORRIGIDO: Era </Hbutton> -->
                            <button onclick="deleteTransacaoLocal('${clienteId}', '${t.id}')" class="text-gray-400 hover:text-red-600 text-xs" title="Excluir Transação">
                               <i data-lucide="trash-2" class="w-3 h-3"></i>
                            </button>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        }
        
        async function handleNovoClienteSubmit(e) {
                senha: document.getElementById('senha').value,
                vendedor: document.getElementById('vendedor').value,
                percentualComissao: parseFloat(document.getElementById('percentualComissao').value) || 0,
                saldoInicial: parseFloat(document.getElementById('saldoInicial').value) || 0, // Salva o saldo inicial

                // Novos campos
                tipoPix: document.getElementById('tipoPix').value,
                chavePix: document.getElementById('chavePix').value,
                cep: document.getElementById('cep').value,
                logradouro: document.getElementById('logradouro').value,
                numero: document.getElementById('numero').value,
                complemento: document.getElementById('complemento').value,
                bairro: document.getElementById('bairro').value,
                cidade: document.getElementById('cidade').value,
                estado: document.getElementById('estado').value
            };
            
            console.log("Adicionando novo cliente:", novoCliente.nome);
            clientes.push(novoCliente);
            transacoes.set(newId, []); // Inicializa o array de transações para o novo cliente
            
            saveData();
            render();
            
            e.target.reset();
            hideModal('novo-cliente-modal');
        }
        
        // --- NOVO: Handler para submit de EDIÇÃO de cliente ---
        async function handleEditClienteSubmit(e) {
            e.preventDefault();
            const clienteId = document.getElementById('edit-cliente-id').value;
            if (!clienteId) {
                showErrorModal("Erro: ID do cliente não encontrado. Não foi possível salvar.");
                return;
            }

            const clienteIndex = clientes.findIndex(c => c.id === clienteId);
            if (clienteIndex === -1) {
                showErrorModal("Erro: Cliente não encontrado na base de dados.");
                return;
            }
            
            // Cria o objeto cliente atualizado
            const updatedCliente = {
                id: clienteId, // Mantém o ID original
                nome: document.getElementById('edit-nome').value,
                telefone: document.getElementById('edit-telefone').value,
                empresa: document.getElementById('edit-empresa').value,
                bandeira: document.getElementById('edit-bandeira').value,
                senha: document.getElementById('edit-senha').value,
                vendedor: document.getElementById('edit-vendedor').value,
                percentualComissao: parseFloat(document.getElementById('edit-percentualComissao').value) || 0,
                saldoInicial: parseFloat(document.getElementById('edit-saldoInicial').value) || 0,
                tipoPix: document.getElementById('edit-tipoPix').value,
                chavePix: document.getElementById('edit-chavePix').value,
                cep: document.getElementById('edit-cep').value,
                logradouro: document.getElementById('edit-logradouro').value,
                numero: document.getElementById('edit-numero').value,
                complemento: document.getElementById('edit-complemento').value,
                bairro: document.getElementById('edit-bairro').value,
                cidade: document.getElementById('edit-cidade').value,
                estado: document.getElementById('edit-estado').value
            };
            
            console.log("Atualizando cliente:", clienteId);
            
            // Substitui o cliente antigo pelo novo no array
            clientes[clienteIndex] = updatedCliente;
            
            saveData();
            render();
            
            e.target.reset();
            hideModal('edit-cliente-modal');
        }
        
        window.deleteClienteLocal = async (id, nome) => {
            if (await showConfirmModal(`Tem certeza que deseja excluir o cliente "${nome}"? Todas as suas transações também serão perdidas.`)) {
                console.log("Excluindo cliente localmente:", id, nome);
                
                // Filtra o cliente do array
                clientes = clientes.filter(c => c.id !== id);
                // Remove as transações do Map
                transacoes.delete(id);
                
                saveData();
                render();
            }
        }
        
        // --- Manipulação de Dados (CRUD Transações) ---

        async function handleNovaTransacaoSubmit(e) {
            e.preventDefault();
            const clienteId = document.getElementById('transacao-cliente-id').value;
            if (!clienteId) return;

            const newId = crypto.randomUUID(); // Gera ID único para a transação
            const novaTransacao = {
                id: newId,
                tipo: document.getElementById('transacao-tipo').value,
                data: document.getElementById('transacao-data').value,
                valor: parseFloat(document.getElementById('transacao-valor').value) || 0,
                loja: document.getElementById('transacao-loja').value // Salva o campo loja
            };
            
            // Validação simples
            if (novaTransacao.tipo === 'saida' && !novaTransacao.loja) {
                showErrorModal("O campo 'Loja' é obrigatório para transações de saída.");
                return; // Impede o envio
            }
            
            const txs = transacoes.get(clienteId);
            if (txs) {
                console.log(`Adicionando transação (${novaTransacao.tipo}) de ${novaTransacao.valor} para o cliente ${clienteId}`);
                txs.push(novaTransacao);
                
                saveData();
                render(); // Re-renderiza para atualizar o extrato e os saldos
                
                e.target.reset();
                // Reseta o campo loja e o container
                document.getElementById('transacao-loja').value = '';
                document.getElementById('loja-input-container').classList.add('hidden');
                
                hideModal('nova-transacao-modal');
            } else {
                console.error(`Cliente com ID ${clienteId} não encontrado no Map de transações.`);
                showErrorModal("Erro: Não foi possível encontrar os dados deste cliente para salvar a transação.");
            }
        }
        
        // --- NOVO: Handler para submit de EDIÇÃO de transação ---
        async function handleEditTransacaoSubmit(e) {
            e.preventDefault();
            const clienteId = document.getElementById('edit-transacao-cliente-id').value;
            const transacaoId = document.getElementById('edit-transacao-id').value;
            
            if (!clienteId || !transacaoId) {
                showErrorModal("Erro: IDs não encontrados. Não foi possível salvar a transação.");
                return;
            }
            
            const editedTransacao = {
                id: transacaoId, // Mantém o ID original
                tipo: document.getElementById('edit-transacao-tipo').value,
                data: document.getElementById('edit-transacao-data').value,
                valor: parseFloat(document.getElementById('edit-transacao-valor').value) || 0,
                loja: document.getElementById('edit-transacao-loja').value
            };
            
            // Validação
            if (editedTransacao.tipo === 'saida' && !editedTransacao.loja) {
                showErrorModal("O campo 'Loja' é obrigatório para transações de saída.");
                return;
            }
            
            const txs = transacoes.get(clienteId);
            if (!txs) {
                showErrorModal("Erro: Cliente não encontrado no Map de transações.");
                return;
            }

            const txIndex = txs.findIndex(t => t.id === transacaoId);
            if (txIndex === -1) {
                showErrorModal("Erro: Transação não encontrada.");
                return;
            }
            
            console.log(`Atualizando transação ${transacaoId} para o cliente ${clienteId}`);
            
            // Substitui a transação antiga pela nova
            txs[txIndex] = editedTransacao;
            transacoes.set(clienteId, txs); // Atualiza o Map
            
            saveData();
            render();
            
            e.target.reset();
            hideModal('edit-transacao-modal');
        }
        
        window.deleteTransacaoLocal = async (clienteId, transacaoId) => {
             if (await showConfirmModal(`Tem certeza que deseja excluir esta transação?`)) {
                 console.log(`Excluindo transação local ${transacaoId} do cliente ${clienteId}`);
                 
                 let txs = transacoes.get(clienteId);
                 if (txs) {
                    // Filtra a transação excluída
                    txs = txs.filter(t => t.id !== transacaoId);
                    // Atualiza o Map
                    transacoes.set(clienteId, txs);
                    
                    saveData();
                    render();
                 }
             }
        }
        
        // --- Ações do WhatsApp ---

        window.showWhatsAppModal = (clienteId) => {
            const cliente = clientes.find(c => c.id === clienteId);
            if (!cliente) {
                console.error("Cliente não encontrado para WhatsApp:", clienteId);
                return;
            }
            
            if (!cliente.telefone || cliente.telefone.trim() === '') {
                showErrorModal("Este cliente não possui um número de telefone cadastrado.");
                return;
            }

            document.getElementById('whatsapp-cliente-nome').textContent = cliente.nome;
            
            // Atribui os handlers aos botões
            document.getElementById('btn-whatsapp-extrato').onclick = () => handleWhatsAppSend('extrato', cliente);
            document.getElementById('btn-whatsapp-pix').onclick = () => handleWhatsAppSend('pix', cliente);

            showModal('whatsapp-options-modal');
        }

        function handleWhatsAppSend(tipo, cliente) {
            let telefone = (cliente.telefone || '').replace(/\D/g, ''); // Remove todos os não-dígitos
            
            // Adiciona o código do país (55) se não estiver presente
            if (telefone.length > 0 && !telefone.startsWith('55')) {
                telefone = '55' + telefone;
            }

            let mensagem = '';
            
            if (tipo === 'extrato') {
                mensagem = `Olá ${cliente.nome}, tudo bem? Por favor, poderia me enviar o print do extrato do seu cartão? Obrigado!`;
            } 
            else if (tipo === 'pix') {
                if (!cliente.chavePix || cliente.chavePix.trim() === '') {
                    showErrorModal("Este cliente não possui uma Chave Pix cadastrada para confirmação.");
                    return;
                }
                mensagem = `Olá ${cliente.nome}, tudo bem? Poderia confirmar se seus dados do Pix (Chave: ${cliente.chavePix}) ainda estão corretos? Obrigado!`;
            }

            const url = `https://wa.me/${telefone}?text=${encodeURIComponent(mensagem)}`; // CORRIGIDO: Era httpsa://
            window.open(url, '_blank');
            
            hideModal('whatsapp-options-modal');
        }

        // --- Funções de Import/Export ---
        
        function exportData() {
            console.log("Exportando dados...");
            try {
                // Prepara o objeto de backup
                const backupData = {
                    clientes: clientes,
                    transacoes: Array.from(transacoes.entries()) // Converte Map para Array
                };
                
                const dataStr = JSON.stringify(backupData, null, 2); // Formata o JSON
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `gestor_clientes_backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                console.log("Exportação concluída.");
            
            } catch (error) {
                console.error("Erro ao exportar dados:", error);
                showErrorModal("Ocorreu um erro ao gerar o arquivo de backup.");
            }
        }
        
        // --- NOVO: Exportação de Extrato CSV ---
        window.exportarExtratoCSV = (clienteId, clienteNome) => {
            console.log(`Exportando extrato CSV para ${clienteNome}`);
            const cliente = clientes.find(c => c.id === clienteId);
            if (!cliente) return;
            
            const txs = transacoes.get(clienteId) || [];
            if (txs.length === 0) {
                showErrorModal("Este cliente não possui transações para exportar.");
                return;
            }
            
            const percentualComissao = (cliente.percentualComissao || 0) / 100;
            
            // Ordena por data (mais antiga primeiro, para extrato)
            txs.sort((a, b) => (a.data || '').localeCompare(b.data || ''));

            const headers = "Data,Tipo,Valor (R$),Loja,Comissão (R$)\n";
            
            let csvContent = headers;
            
            txs.forEach(t => {
                const data = formatDate(t.data);
                const tipo = t.tipo === 'entrada' ? 'Entrada' : 'Saída';
                // Formata para CSV (usando vírgula como decimal)
                const valor = (t.valor || 0).toFixed(2).replace('.', ','); 
                const loja = t.loja || '';
                const comissao = t.tipo === 'entrada' ? (t.valor * percentualComissao).toFixed(2).replace('.', ',') : '0,00';
                
                // Coloca aspas para garantir que vírgulas no nome da loja não quebrem o CSV
                const linha = `"${data}","${tipo}","${valor}","${loja}","${comissao}"\n`;
                csvContent += linha;
            });
            
            try {
                // \uFEFF (Byte Order Mark) garante que o Excel abra o UTF-8 corretamente
                const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `extrato_${clienteNome.replace(/ /g, '_')}_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                console.log("Exportação CSV concluída.");

            } catch (error) {
                console.error("Erro ao exportar CSV:", error);
                showErrorModal("Ocorreu um erro ao gerar o arquivo CSV.");
            }
        }
        
        window.handleFileSelect = (event) => {
            const file = event.target.files[0];
            if (!file) {
                return;
            }
            console.log("Arquivo selecionado para importação:", file.name);
            
            const reader = new FileReader();
            
            reader.onload = async (e) => {
                const content = e.target.result;
                try {
                    const data = JSON.parse(content);
                    
                    // Validação simples do arquivo
                    if (data && Array.isArray(data.clientes) && Array.isArray(data.transacoes)) {
                        
                        if (await showConfirmModal(`Você tem certeza? Isso irá SOBRESCREVER todos os dados atuais pelos dados do arquivo.`)) {
                            clientes = data.clientes;
                            transacoes = new Map(data.transacoes); // Converte Array de volta para Map
                            
                            saveData();
                            // Reseta os filtros e renderiza
                            document.getElementById('search-input').value = '';
                            document.getElementById('filtro-bandeira').value = '';
                            document.getElementById('filtro-vendedor').value = '';
                            document.getElementById('filtro-ordenacao').value = 'nome';
                            searchQuery = '';
                            filtroBandeira = '';
                            filtroVendedor = '';
                            criterioOrdenacao = 'nome';
                            render();
                            
                            console.log("Dados importados com sucesso.");
                        }
                        
                    } else {
                        throw new Error("Formato de arquivo inválido.");
                    }
                    
                } catch (error) {
                    console.error("Erro ao importar arquivo:", error);
                    showErrorModal("Erro ao ler o arquivo. O arquivo pode estar corrompido ou não ser um backup válido.");
                } finally {
                    // Limpa o input de arquivo para permitir importar o mesmo arquivo novamente
                    event.target.value = null;
                }
            };
            
            reader.readAsText(file);
        }

        // --- Helpers (Modals, Formatos, UI) ---
        function showModal(modalId, contextData = null) {
            if (modalId === 'nova-transacao-modal' && contextData) {
                const { clienteId, clienteNome } = contextData;
                document.getElementById('transacao-cliente-id').value = clienteId;
                document.getElementById('transacao-cliente-nome').textContent = clienteNome;
                document.getElementById('transacao-data').valueAsDate = new Date();
                
                // Reseta o campo loja e o seletor de tipo
                document.getElementById('transacao-loja').value = '';
                document.getElementById('loja-input-container').classList.add('hidden');
                document.getElementById('transacao-tipo').value = 'entrada'; // Padrão
            }
            
            const modal = document.getElementById(modalId);
            if(modal) modal.classList.remove('hidden');
        }

        function hideModal(modalId) {
            const modal = document.getElementById(modalId);
            if(modal) modal.classList.add('hidden');
        }
        
        window.showTransactionModal = (clienteId, clienteNome) => {
             showModal('nova-transacao-modal', { clienteId, clienteNome });
        }

        // --- NOVO: Mostrar Modal de Edição de Cliente ---
        window.showEditClienteModal = (clienteId) => {
            const cliente = clientes.find(c => c.id === clienteId);
            if (!cliente) {
                showErrorModal("Erro: Cliente não encontrado.");
                return;
            }
            
            console.log("Abrindo modal de edição para:", cliente.nome);
            
            // Preenche o formulário de edição
            document.getElementById('edit-cliente-id').value = cliente.id;
            document.getElementById('edit-nome').value = cliente.nome;
            document.getElementById('edit-telefone').value = cliente.telefone || '';
            document.getElementById('edit-empresa').value = cliente.empresa || '';
            document.getElementById('edit-senha').value = cliente.senha || '';
            document.getElementById('edit-bandeira').value = cliente.bandeira || '';
            document.getElementById('edit-vendedor').value = cliente.vendedor || '';
            document.getElementById('edit-percentualComissao').value = cliente.percentualComissao || 0;
            document.getElementById('edit-saldoInicial').value = cliente.saldoInicial || 0;
            
            document.getElementById('edit-tipoPix').value = cliente.tipoPix || '';
            document.getElementById('edit-chavePix').value = cliente.chavePix || '';
            document.getElementById('edit-cep').value = cliente.cep || '';
            document.getElementById('edit-logradouro').value = cliente.logradouro || '';
            document.getElementById('edit-numero').value = cliente.numero || '';
            document.getElementById('edit-complemento').value = cliente.complemento || '';
            document.getElementById('edit-bairro').value = cliente.bairro || '';
            document.getElementById('edit-cidade').value = cliente.cidade || '';
            document.getElementById('edit-estado').value = cliente.estado || '';
            
            showModal('edit-cliente-modal');
        }
        
        // --- NOVO: Mostrar Modal de Edição de Transação ---
        window.showEditTransacaoModal = (clienteId, transacaoId) => {
            const txs = transacoes.get(clienteId);
            if (!txs) {
                showErrorModal("Erro: Cliente não encontrado.");
                return;
            }
            
            const transacao = txs.find(t => t.id === transacaoId);
            if (!transacao) {
                showErrorModal("Erro: Transação não encontrada.");
                return;
            }
            
            console.log("Abrindo modal de edição para transação:", transacaoId);

            // Preenche o formulário de edição
            document.getElementById('edit-transacao-cliente-id').value = clienteId;
            document.getElementById('edit-transacao-id').value = transacao.id;
            document.getElementById('edit-transacao-tipo').value = transacao.tipo;
            document.getElementById('edit-transacao-data').value = transacao.data;
            document.getElementById('edit-transacao-valor').value = transacao.valor;
            document.getElementById('edit-transacao-loja').value = transacao.loja || '';
            
            // Mostra/oculta o campo loja
            const lojaContainer = document.getElementById('edit-loja-input-container');
            if (transacao.tipo === 'saida') {
                lojaContainer.classList.remove('hidden');
            } else {
                lojaContainer.classList.add('hidden');
            }
            
            showModal('edit-transacao-modal');
        }

        window.toggleTransactions = (clienteId) => {
            const lista = document.getElementById(`extrato-lista-${clienteId}`);
            if (lista) {
                lista.classList.toggle('visible');
                if (lista.classList.contains('visible') && window.lucide) {
                    window.lucide.createIcons();
                }
            }
        }
        
        function showConfirmModal(message, isError = false) {
            return new Promise((resolve) => {
                const oldModal = document.getElementById('confirm-modal-overlay');
                if (oldModal) oldModal.remove();

                const overlay = document.createElement('div');
                overlay.id = 'confirm-modal-overlay';
                overlay.className = 'fixed inset-0 z-[100] flex items-center justify-center bg-black bg-opacity-50 transition-opacity';
                
                const modal = document.createElement('div');
                modal.className = 'bg-white rounded-lg shadow-xl p-6 w-full max-w-sm mx-4 transform transition-all scale-95 opacity-0';
                
                const msg = document.createElement('p');
                msg.className = 'text-lg font-medium text-gray-800 mb-4';
                msg.textContent = message;
                modal.appendChild(msg);
                
                const btnContainer = document.createElement('div');
                btnContainer.className = 'flex justify-end gap-3';
                
                if (!isError) {
                    const cancelBtn = document.createElement('button');
                    cancelBtn.className = 'px-4 py-2 rounded-md text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-300 focus:ring-offset-2';
                    cancelBtn.textContent = 'Cancelar';
                    cancelBtn.onclick = () => closeModal(false);
                    btnContainer.appendChild(cancelBtn);
                }
                
                const confirmBtn = document.createElement('button');
                confirmBtn.className = `px-4 py-2 rounded-md text-sm font-medium text-white focus:outline-none focus:ring-2 focus:ring-offset-2`;
                
                if (isError) {
                   confirmBtn.textContent = 'OK';
                   confirmBtn.classList.add('bg-blue-600', 'hover:bg-blue-700', 'focus:ring-blue-500');
                } else {
                   confirmBtn.textContent = 'Confirmar'; // Texto genérico para confirmação
                   confirmBtn.classList.add('bg-red-600', 'hover:bg-red-700', 'focus:ring-red-500');
                }
                
                confirmBtn.onclick = () => closeModal(true);
                
                btnContainer.appendChild(confirmBtn);
                modal.appendChild(btnContainer);
                overlay.appendChild(modal);
                document.body.appendChild(overlay);

                requestAnimationFrame(() => {
                    overlay.classList.add('opacity-100');
                    modal.classList.remove('scale-95', 'opacity-0');
                    modal.classList.add('scale-100', 'opacity-100');
                });
                
                function closeModal(result) {
                    modal.classList.remove('scale-100', 'opacity-100');
                    modal.classList.add('scale-95', 'opacity-0');
                    overlay.classList.remove('opacity-100');
                    overlay.classList.add('opacity-0');
                    
                    setTimeout(() => {
                        overlay.remove();
                        resolve(result);
                    }, 150);
                }
            });
        }
        
        // Função de Modal de Erro dedicada
        function showErrorModal(message) {
            // Reutiliza o showConfirmModal no modo 'isError'
            showConfirmModal(message, true);
        }
        
        
        // ... (Helpers de Formatação permanecem iguais) ...
        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value || 0);
        }

        function formatPercentage(value) {
            return (value || 0).toFixed(2).replace('.', ',') + '%';
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            try {
                // Adiciona T00:00:00 para garantir que a data seja interpretada como local
                const date = new Date(dateString + 'T00:00:00');
                if (isNaN(date.getTime())) return dateString;
                // 'pt-BR' já usa o fuso horário local implicitamente
                return date.toLocaleDateString('pt-BR'); 
            } catch (e) {
                return dateString;
            }
        }
        
        // --- Handlers de Filtro ---
        function handleSearch(e) {
            searchQuery = e.target.value;
            console.log("Busca por nome:", searchQuery);
            render();
        }
        
        function handleFiltroBandeira(e) {
            filtroBandeira = e.target.value;
            console.log("Filtro Bandeira:", filtroBandeira);
            render();
        }
        
        function handleFiltroVendedor(e) {
            filtroVendedor = e.target.value;
            console.log("Filtro Vendedor:", filtroVendedor);
            render();
        }
        
        function handleFiltroOrdenacao(e) {
            criterioOrdenacao = e.target.value;
            console.log("Critério de Ordenação:", criterioOrdenacao);
            render();
        }
        
        // --- Event Listeners Globais ---
        
        // Botões dos Modais
        document.getElementById('show-novo-cliente-modal').addEventListener('click', () => showModal('novo-cliente-modal'));
        document.getElementById('close-novo-cliente-modal').addEventListener('click', () => hideModal('novo-cliente-modal'));
        document.getElementById('close-nova-transacao-modal').addEventListener('click', () => hideModal('nova-transacao-modal'));
        document.getElementById('close-whatsapp-options-modal').addEventListener('click', () => hideModal('whatsapp-options-modal'));
        document.getElementById('close-edit-cliente-modal').addEventListener('click', () => hideModal('edit-cliente-modal')); // NOVO
        document.getElementById('close-edit-transacao-modal').addEventListener('click', () => hideModal('edit-transacao-modal')); // NOVO
        
        // Forms
        document.getElementById('novo-cliente-form').addEventListener('submit', handleNovoClienteSubmit);
        document.getElementById('nova-transacao-form').addEventListener('submit', handleNovaTransacaoSubmit);
        document.getElementById('edit-cliente-form').addEventListener('submit', handleEditClienteSubmit); // NOVO
        document.getElementById('edit-transacao-form').addEventListener('submit', handleEditTransacaoSubmit); // NOVO
        
        // Listener para mostrar/ocultar campo Loja
        document.getElementById('transacao-tipo').addEventListener('change', (e) => {
            const lojaContainer = document.getElementById('loja-input-container');
            if (e.target.value === 'saida') {
                lojaContainer.classList.remove('hidden');
            } else {
                lojaContainer.classList.add('hidden');
            }
        });
        
        // NOVO: Listener para mostrar/ocultar campo Loja (no modal de edição)
        document.getElementById('edit-transacao-tipo').addEventListener('change', (e) => {
            const lojaContainer = document.getElementById('edit-loja-input-container');
            if (e.target.value === 'saida') {
                lojaContainer.classList.remove('hidden');
            } else {
                lojaContainer.classList.add('hidden');
            }
        });
        
        // Botões Import/Export
        document.getElementById('export-button').addEventListener('click', exportData);
        
        // Botão Import
        document.getElementById('import-button').addEventListener('click', () => {
            // Clica no input de arquivo escondido
            document.getElementById('import-file-input').click();
        });

        // Inicializa a aplicação e os ícones
        window.lucide.createIcons();
        initApp(); // Inicia a aplicação
        
    </script>

</body>
</html>

