<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Clientes (Cards)</title>
    <!-- Carrega o Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Biblioteca de ícones (Lucide) -->
    <script src="https://unpkg.com/lucide-react@0.395.0/dist/umd/lucide.min.js"></script>
    <style>
        /* Estilo para a fonte Inter (Padrão iOS/Minimalista) */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa; /* Cinza claro */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* Remove setas de inputs de número */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
        
        /* Animação para 'Ver Extrato' */
        .extrato-lista {
            transition: all 0.3s ease-in-out;
            overflow: hidden;
            max-height: 0;
            opacity: 0;
        }
        .extrato-lista.visible {
            max-height: 1000px; /* Altura suficiente */
            opacity: 1;
            margin-top: 1rem;
        }
        
        /* Estilo Padrão para Inputs */
        .form-input, .form-select {
            @apply mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm;
        }

        /* Estilo para Modais */
        .modal-overlay {
            @apply fixed inset-0 z-50 flex justify-center bg-black bg-opacity-50 hidden;
        }
        /* Para modais pequenos (Transação, WhatsApp, Confirmação) */
        .modal-small {
            @apply bg-white rounded-lg shadow-xl p-6 w-full max-w-md m-auto transform transition-all;
        }
        /* Para modais grandes (Novo/Editar Cliente) */
        .modal-large-container {
            @apply fixed inset-0 z-50 flex justify-center bg-black bg-opacity-50 hidden overflow-y-auto pt-12 pb-12;
        }
        .modal-large-content {
            @apply bg-white rounded-lg shadow-xl p-6 w-full max-w-lg mx-auto transform transition-all max-h-[90vh] overflow-y-auto;
        }

    </style>
</head>
<body class="bg-gray-50 text-gray-900 antialiased">

    <!-- Container Principal -->
    <div class="container mx-auto max-w-7xl p-4 sm:p-6 lg:p-8">

        <h1 class="text-3xl font-bold text-gray-800 mb-6">Gestor de Clientes</h1>

        <!-- Seção de Estatísticas (Cabeçalho) -->
        <div id="stats-header" class="mb-6 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
            <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                <h3 class="text-sm font-medium text-gray-500 truncate">Qtd. Clientes (Filtro)</h3>
                <p id="stat-qtd-clientes" class="mt-1 text-3xl font-semibold text-gray-900">0</p>
            </div>
            <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                <h3 class="text-sm font-medium text-gray-500 truncate">Saldo Total (Filtro)</h3>
                <p id="stat-saldo-total" class="mt-1 text-3xl font-semibold text-gray-900">R$ 0,00</p>
            </div>
            <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                <h3 class="text-sm font-medium text-gray-500 truncate">Total Comissões (Filtro)</h3>
                <p id="stat-total-comissoes" class="mt-1 text-3xl font-semibold text-gray-900">R$ 0,00</p>
            </div>
             <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                <h3 class="text-sm font-medium text-gray-500 truncate">Qtd. Total (Global)</h3>
                <p id="stat-qtd-global" class="mt-1 text-3xl font-semibold text-gray-900">0</p>
            </div>
        </div>

        <!-- Seção de Controles (Busca, Import/Export, Novo Cliente) -->
        <div class="mb-6 flex flex-col md:flex-row justify-between items-center gap-4">
            <!-- Barra de Busca -->
            <div class="relative w-full md:max-w-xs">
                <input 
                    type="text" 
                    id="search-input" 
                    placeholder="Buscar cliente por nome..."
                    class="w-full pl-10 pr-4 py-2 rounded-md border-gray-300 focus:border-blue-500 focus:ring-blue-500"
                >
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <i data-lucide="search" class="w-5 h-5 text-gray-400"></i>
                </div>
            </div>
            
            <!-- Grupo de Botões -->
            <div class="flex flex-col sm:flex-row gap-3 w-full md:w-auto">
                 <!-- Botões Import/Export -->
                <input type="file" id="import-file-input" class="hidden" accept=".json">
                <button 
                    id="import-button"
                    class="w-full sm:w-auto inline-flex justify-center rounded-md border border-gray-300 bg-white py-2 px-4 text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
                >
                    <i data-lucide="upload" class="w-5 h-5 mr-2"></i>
                    Importar
                </button>
                <button 
                    id="export-button"
                    class="w-full sm:w-auto inline-flex justify-center rounded-md border border-gray-300 bg-white py-2 px-4 text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
                >
                    <i data-lucide="download" class="w-5 h-5 mr-2"></i>
                    Exportar
                </button>

                <!-- Botão Novo Cliente -->
                <button 
                    id="show-novo-cliente-modal"
                    class="w-full sm:w-auto inline-flex justify-center rounded-md border border-transparent bg-blue-500 py-2 px-4 text-sm font-medium text-white shadow-sm hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
                >
                    <i data-lucide="user-plus" class="w-5 h-5 mr-2"></i>
                    Novo Cliente
                </button>
            </div>
        </div>
        
        <!-- Seção de Filtros (Segmentadores) -->
        <div id="filters-container" class="mb-6 flex flex-col sm:flex-row flex-wrap gap-4 p-4 bg-white rounded-lg border border-gray-200 shadow-sm">
            <h3 class="text-lg font-medium text-gray-800 sm:self-center w-full sm:w-auto mb-2 sm:mb-0">Filtros:</h3>
            
            <!-- Filtro por Bandeira -->
            <div class="flex-1 min-w-[150px]">
                <label for="filtro-bandeira" class="block text-sm font-medium text-gray-700">Bandeira</label>
                <select id="filtro-bandeira" class="form-select">
                    <option value="">Todas</option>
                    <option value="ALELO">ALELO</option>
                    <option value="SODEXO/PLUXEE">SODEXO/PLUXEE</option>
                    <option value="VR">VR</option>
                    <option value="CABAL">CABAL</option>
                    <option value="TICKET">TICKET</option>
                    <option value="R6">R6</option>
                    <option value="FLASH">FLASH</option>
                    <option value="IFOOD">IFOOD</option>
                    <option value="HEINEKEN">HEINEKEN</option>
                    <option value="Outra">Outra</option>
                </select>
            </div>
            
            <!-- Filtro por Vendedor -->
            <div class="flex-1 min-w-[150px]">
                <label for="filtro-vendedor" class="block text-sm font-medium text-gray-700">Vendedor</label>
                <select id="filtro-vendedor" class="form-select">
                    <option value="">Todos</option>
                    <option value="Osvaldo">Osvaldo</option>
                    <option value="Lucas">Lucas</option>
                    <option value="Claudenil">Claudenil</option>
                    <option value="Outro">Outro</option>
                </select>
            </div>

            <!-- Filtro de Ordenação -->
            <div class="flex-1 min-w-[150px]">
                <label for="filtro-ordenacao" class="block text-sm font-medium text-gray-700">Ordenar por</label>
                <select id="filtro-ordenacao" class="form-select">
                    <option value="nome">Nome (A-Z)</option>
                    <option value="empresa">Empresa (A-Z)</option>
                    <option value="saldoDesc">Saldo (Maior)</option>
                    <option value="saldoAsc">Saldo (Menor)</option>
                    <option value="comissaoDesc">Comissão (Maior)</option>
                    <option value="comissaoAsc">Comissão (Menor)</option>
                </select>
            </div>
        </div>


        <!-- Seção de Cards de Clientes -->
        <div id="client-cards-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Cards de clientes serão injetados aqui -->
            <p class="text-gray-500 col-span-full text-center" id="loading-message">Carregando dados...</p>
        </div>
        
    </div> <!-- Fim do Container Principal -->
    
    <!-- Notificação de "Salvo" -->
    <div id="save-toast" class="fixed bottom-4 right-4 z-[100] bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg opacity-0 transition-opacity duration-300 pointer-events-none">
        <i data-lucide="check-circle" class="inline-block w-5 h-5 mr-2"></i>
        Salvo com sucesso!
    </div>

    <!-- Modal: Novo Cliente (Layout Grande com Rolagem) -->
    <div id="novo-cliente-modal" class="modal-large-container">
        <div class="modal-large-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-semibold text-gray-800">Cadastrar Novo Cliente</h2>
                <button data-close-modal="novo-cliente-modal" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <form id="novo-cliente-form" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <!-- Coluna 1 -->
                <div>
                    <label for="nome" class="block text-sm font-medium text-gray-700">Nome *</label>
                    <input type="text" id="nome" required class="form-input">
                </div>
                <div>
                    <label for="telefone" class="block text-sm font-medium text-gray-700">Telefone</label>
                    <input type="tel" id="telefone" class="form-input" placeholder="Ex: 11987654321">
                </div>
                <div>
                    <label for="empresa" class="block text-sm font-medium text-gray-700">Empresa</label>
                    <input type="text" id="empresa" class="form-input">
                </div>
                 <div>
                    <label for="senha" class="block text-sm font-medium text-gray-700">Senha</label>
                    <input type="text" id="senha" class="form-input">
                </div>
                
                <!-- Coluna 2 -->
                <div>
                    <label for="bandeira" class="block text-sm font-medium text-gray-700">Bandeira</label>
                    <select id="bandeira" class="form-select">
                        <option value="">Selecione...</option>
                        <option value="ALELO">ALELO</option>
                        <option value="SODEXO/PLUXEE">SODEXO/PLUXEE</option>
                        <option value="VR">VR</option>
                        <option value="CABAL">CABAL</option>
                        <option value="TICKET">TICKET</option>
                        <option value="R6">R6</option>
                        <option value="FLASH">FLASH</option>
                        <option value="IFOOD">IFOOD</option>
                        <option value="HEINEKEN">HEINEKEN</option>
                        <option value="Outra">Outra</option>
                    </select>
                </div>
                <div>
                    <label for="vendedor" class="block text-sm font-medium text-gray-700">Vendedor</label>
                    <select id="vendedor" class="form-select">
                        <option value="">Selecione...</option>
                        <option value="Osvaldo">Osvaldo</option>
                        <option value="Lucas">Lucas</option>
                        <option value="Claudenil">Claudenil</option>
                        <option value="Outro">Outro</option>
                    </select>
                </div>
                <div>
                    <label for="percentualComissao" class="block text-sm font-medium text-gray-700">% Comissão *</label>
                    <input type="number" id="percentualComissao" step="0.01" min="0" required class="form-input" placeholder="Ex: 10.5">
                </div>
                <div>
                    <label for="saldoInicial" class="block text-sm font-medium text-gray-700">Saldo Inicial (R$)</label>
                    <input type="number" id="saldoInicial" step="0.01" class="form-input" placeholder="Opcional. Ex: 150.00">
                </div>
                
                <!-- Campos de Pix -->
                <div class="col-span-full sm:col-span-1">
                    <label for="tipoPix" class="block text-sm font-medium text-gray-700">Tipo Chave Pix</label>
                    <select id="tipoPix" class="form-select">
                        <option value="">Nenhuma</option>
                        <option value="celular">Celular</option>
                        <option value="cpf_cnpj">CPF/CNPJ</option>
                        <option value="email">Email</option>
                        <option value="aleatoria">Aleatória</option>
                    </select>
                </div>
                <div class="col-span-full sm:col-span-1">
                    <label for="chavePix" class="block text-sm font-medium text-gray-700">Chave Pix</label>
                    <input type="text" id="chavePix" class="form-input">
                </div>

                <!-- Campos de Endereço -->
                <div class="col-span-full">
                    <h3 class="text-md font-medium text-gray-700 mt-4 border-t pt-4">Endereço (Opcional)</h3>
                </div>
                <div class="col-span-full sm:col-span-1">
                    <label for="cep" class="block text-sm font-medium text-gray-700">CEP</label>
                    <input type="text" id="cep" class="form-input">
                </div>
                <div class="col-span-full sm:col-span-1">
                    <label for="logradouro" class="block text-sm font-medium text-gray-700">Logradouro</label>
                    <input type="text" id="logradouro" class="form-input">
                </div>
                <div class="col-span-full sm:col-span-1">
                    <label for="numero" class="block text-sm font-medium text-gray-700">Número</label>
                    <input type="text" id="numero" class="form-input">
                </div>
                <div class="col-span-full sm:col-span-1">
                    <label for="complemento" class="block text-sm font-medium text-gray-700">Complemento</label>
                    <input type="text" id="complemento" class="form-input">
                </div>
                <div class="col-span-full sm:col-span-1">
                    <label for="bairro" class="block text-sm font-medium text-gray-700">Bairro</label>
                    <input type="text" id="bairro" class="form-input">
                </div>
                <div class="col-span-full sm:col-span-1">
                    <label for="cidade" class="block text-sm font-medium text-gray-700">Cidade</label>
                    <input type="text" id="cidade" class="form-input">
                </div>
                <div class="col-span-full sm:col-span-1">
                    <label for="estado" class="block text-sm font-medium text-gray-700">Estado</label>
                    <input type="text" id="estado" maxlength="2" class="form-input" placeholder="Ex: SP">
                </div>

                <!-- Botão de Envio -->
                <div class="col-span-full flex justify-end mt-4">
                    <button type="submit" class="inline-flex justify-center rounded-md border border-transparent bg-blue-500 py-2 px-4 text-sm font-medium text-white shadow-sm hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                        Salvar Cliente
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal: EDITAR Cliente (Layout Grande com Rolagem) -->
    <div id="edit-cliente-modal" class="modal-large-container">
        <div class="modal-large-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-semibold text-gray-800">Editar Cliente</h2>
                <button data-close-modal="edit-cliente-modal" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <form id="edit-cliente-form" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <input type="hidden" id="edit-cliente-id">
                
                <!-- Coluna 1 -->
                <div>
                    <label for="edit-nome" class="block text-sm font-medium text-gray-700">Nome *</label>
                    <input type="text" id="edit-nome" required class="form-input">
                </div>
                <div>
                    <label for="edit-telefone" class="block text-sm font-medium text-gray-700">Telefone</label>
                    <input type="tel" id="edit-telefone" class="form-input" placeholder="Ex: 11987654321">
                </div>
                <div>
                    <label for="edit-empresa" class="block text-sm font-medium text-gray-700">Empresa</label>
                    <input type="text" id="edit-empresa" class="form-input">
                </div>
                 <div>
                    <label for="edit-senha" class="block text-sm font-medium text-gray-700">Senha</label>
                    <input type="text" id="edit-senha" class="form-input">
                </div>
                
                <!-- Coluna 2 -->
                <div>
                    <label for="edit-bandeira" class="block text-sm font-medium text-gray-700">Bandeira</label>
                    <select id="edit-bandeira" class="form-select">
                        <option value="">Selecione...</option>
                        <option value="ALELO">ALELO</option>
                        <option value="SODEXO/PLUXEE">SODEXO/PLUXEE</option>
                        <option value="VR">VR</option>
                        <option value="CABAL">CABAL</option>
                        <option value="TICKET">TICKET</option>
                        <option value="R6">R6</option>
                        <option value="FLASH">FLASH</option>
                        <option value="IFOOD">IFOOD</option>
                        <option value="HEINEKEN">HEINEKEN</option>
                        <option value="Outra">Outra</option>
                    </select>
                </div>
                <div>
                    <label for="edit-vendedor" class="block text-sm font-medium text-gray-700">Vendedor</label>
                    <select id="edit-vendedor" class="form-select">
                        <option value="">Selecione...</option>
                        <option value="Osvaldo">Osvaldo</option>
                        <option value="Lucas">Lucas</option>
                        <option value="Claudenil">Claudenil</option>
                        <option value="Outro">Outro</option>
                    </select>
                </div>
                <div>
                    <label for="edit-percentualComissao" class="block text-sm font-medium text-gray-700">% Comissão *</label>
                    <input type="number" id="edit-percentualComissao" step="0.01" min="0" required class="form-input" placeholder="Ex: 10.5">
                </div>
                <div>
                    <label for="edit-saldoInicial" class="block text-sm font-medium text-gray-700">Saldo Inicial (R$)</label>
                    <input type="number" id="edit-saldoInicial" step="0.01" class="form-input" placeholder="Opcional. Ex: 150.00">
                </div>
                
                <!-- Campos de Pix -->
                <div class="col-span-full sm:col-span-1">
                    <label for="edit-tipoPix" class="block text-sm font-medium text-gray-700">Tipo Chave Pix</label>
                    <select id="edit-tipoPix" class="form-select">
                        <option value="">Nenhuma</option>
                        <option value="celular">Celular</option>
                        <option value="cpf_cnpj">CPF/CNPJ</option>
                        <option value="email">Email</option>
                        <option value="aleatoria">Aleatória</option>
                    </select>
                </div>
                <div class="col-span-full sm:col-span-1">
                    <label for="edit-chavePix" class="block text-sm font-medium text-gray-700">Chave Pix</label>
                    <input type="text" id="edit-chavePix" class="form-input">
                </div>

                <!-- Campos de Endereço -->
                <div class="col-span-full">
                    <h3 class="text-md font-medium text-gray-700 mt-4 border-t pt-4">Endereço (Opcional)</h3>
                </div>
                <div class="col-span-full sm:col-span-1">
                    <label for="edit-cep" class="block text-sm font-medium text-gray-700">CEP</label>
                    <input type="text" id="edit-cep" class="form-input">
                </div>
                <div class="col-span-full sm:col-span-1">
                    <label for="edit-logradouro" class="block text-sm font-medium text-gray-700">Logradouro</label>
                    <input type="text" id="edit-logradouro" class="form-input">
                </div>
                <div class="col-span-full sm:col-span-1">
                    <label for="edit-numero" class="block text-sm font-medium text-gray-700">Número</label>
                    <input type="text" id="edit-numero" class="form-input">
                </div>
                <div class="col-span-full sm:col-span-1">
                    <label for="edit-complemento" class="block text-sm font-medium text-gray-700">Complemento</label>
                    <input type="text" id="edit-complemento" class="form-input">
                </div>
                <div class="col-span-full sm:col-span-1">
                    <label for="edit-bairro" class="block text-sm font-medium text-gray-700">Bairro</label>
                    <input type="text" id="edit-bairro" class="form-input">
                </div>
                <div class="col-span-full sm:col-span-1">
                    <label for="edit-cidade" class="block text-sm font-medium text-gray-700">Cidade</label>
                    <input type="text" id="edit-cidade" class="form-input">
                </div>
                <div class="col-span-full sm:col-span-1">
                    <label for="edit-estado" class="block text-sm font-medium text-gray-700">Estado</label>
                    <input type="text" id="edit-estado" maxlength="2" class="form-input" placeholder="Ex: SP">
                </div>

                <!-- Botão de Envio -->
                <div class="col-span-full flex justify-end mt-4">
                    <button type="submit" class="inline-flex justify-center rounded-md border border-transparent bg-blue-500 py-2 px-4 text-sm font-medium text-white shadow-sm hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                        Atualizar Cliente
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal: Nova Transação (Layout Pequeno) -->
    <div id="nova-transacao-modal" class="modal-overlay items-center">
        <div class="modal-small">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-semibold text-gray-800">Nova Transação</h2>
                <button data-close-modal="nova-transacao-modal" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <form id="nova-transacao-form" class="space-y-4">
                <input type="hidden" id="transacao-cliente-id">
                <p class="text-sm text-gray-600">Adicionando para: <strong id="transacao-cliente-nome" class="text-gray-800">...</strong></p>
                
                <div>
                    <label for="transacao-tipo" class="block text-sm font-medium text-gray-700">Tipo *</label>
                    <select id="transacao-tipo" required class="form-select">
                        <option value="entrada">Entrada (Crédito)</option>
                        <option value="saida">Saída (Uso)</option>
                    </select>
                </div>
                
                <div id="loja-input-container" class="hidden"> <!-- Campo Loja (inicia oculto) -->
                    <label for="transacao-loja" class="block text-sm font-medium text-gray-700">Loja *</label>
                    <input type="text" id="transacao-loja" class="form-input">
                </div>
                
                <div>
                    <label for="transacao-data" class="block text-sm font-medium text-gray-700">Data *</label>
                    <input type="date" id="transacao-data" required class="form-input">
                </div>
                
                <div>
                    <label for="transacao-valor" class="block text-sm font-medium text-gray-700">Valor (R$) *</label>
                    <input type="number" id="transacao-valor" step="0.01" min="0" required class="form-input">
                </div>

                <div class="flex justify-end mt-4">
                    <button type="submit" class="inline-flex justify-center rounded-md border border-transparent bg-blue-500 py-2 px-4 text-sm font-medium text-white shadow-sm hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                        Salvar Transação
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: EDITAR Transação (Layout Pequeno) -->
    <div id="edit-transacao-modal" class="modal-overlay items-center">
        <div class="modal-small">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-semibold text-gray-800">Editar Transação</h2>
                <button data-close-modal="edit-transacao-modal" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <form id="edit-transacao-form" class="space-y-4">
                <input type="hidden" id="edit-transacao-cliente-id">
                <input type="hidden" id="edit-transacao-id">
                
                <div>
                    <label for="edit-transacao-tipo" class="block text-sm font-medium text-gray-700">Tipo *</label>
                    <select id="edit-transacao-tipo" required class="form-select">
                        <option value="entrada">Entrada (Crédito)</option>
                        <option value="saida">Saída (Uso)</option>
                    </select>
                </div>
                
                <div id="edit-loja-input-container" class="hidden"> <!-- Campo Loja (inicia oculto) -->
                    <label for="edit-transacao-loja" class="block text-sm font-medium text-gray-700">Loja *</label>
                    <input type="text" id="edit-transacao-loja" class="form-input">
                </div>
                
                <div>
                    <label for="edit-transacao-data" class="block text-sm font-medium text-gray-700">Data *</label>
                    <input type="date" id="edit-transacao-data" required class="form-input">
                </div>
                
                <div>
                    <label for="edit-transacao-valor" class="block text-sm font-medium text-gray-700">Valor (R$) *</label>
                    <input type="number" id="edit-transacao-valor" step="0.01" min="0" required class="form-input">
                </div>

                <div class="flex justify-end mt-4">
                    <button type="submit" class="inline-flex justify-center rounded-md border border-transparent bg-blue-500 py-2 px-4 text-sm font-medium text-white shadow-sm hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                        Atualizar Transação
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Opções WhatsApp (Layout Pequeno) -->
    <div id="whatsapp-options-modal" class="modal-overlay items-center">
        <div class="modal-small max-w-sm">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-800">WhatsApp para <span id="whatsapp-cliente-nome" class="font-bold">...</span></h2>
                <button data-close-modal="whatsapp-options-modal" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div class="space-y-3">
                <p class="text-sm text-gray-600">Selecione uma mensagem pré-definida para enviar.</p>
                <button 
                    id="btn-whatsapp-extrato"
                    class="w-full inline-flex justify-center items-center rounded-md border border-gray-300 bg-white py-2 px-4 text-sm font-medium text-gray-700 hover:bg-gray-50"
                >
                    <i data-lucide="list-check" class="w-5 h-5 mr-2"></i>
                    Pedir print do extrato
                </button>
                <button 
                    id="btn-whatsapp-pix"
                    class="w-full inline-flex justify-center items-center rounded-md border border-gray-300 bg-white py-2 px-4 text-sm font-medium text-gray-700 hover:bg-gray-50"
                >
                    <i data-lucide="key-round" class="w-5 h-5 mr-2"></i>
                    Confirmar dados do Pix
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmação (Genérico) -->
    <div id="confirm-modal" class="modal-overlay items-center">
        <div class="modal-small max-w-sm">
             <h3 id="confirm-modal-title" class="text-lg font-medium text-gray-900">Confirmar Ação</h3>
             <p id="confirm-modal-message" class="text-sm text-gray-600 mt-2 mb-4">Tem certeza?</p>
             <div class="flex justify-end gap-3 mt-4">
                <button id="confirm-modal-cancel" class="px-4 py-2 rounded-md text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200">
                    Cancelar
                </button>
                <button id="confirm-modal-ok" class="px-4 py-2 rounded-md text-sm font-medium text-white bg-red-600 hover:bg-red-700">
                    Confirmar
                </button>
             </div>
        </div>
    </div>

    <!-- Modal de Erro (Genérico) -->
    <div id="error-modal" class="modal-overlay items-center">
        <div class="modal-small max-w-sm">
             <div class="flex items-center">
                <i data-lucide="alert-triangle" class="w-6 h-6 text-red-500 mr-3"></i>
                <h3 class="text-lg font-medium text-gray-900">Erro</h3>
             </div>
             <p id="error-modal-message" class="text-sm text-gray-600 mt-2 mb-4">Ocorreu um erro.</p>
             <div class="flex justify-end gap-3 mt-4">
                <button id="error-modal-ok" class="px-4 py-2 rounded-md text-sm font-medium text-white bg-blue-500 hover:bg-blue-600">
                    OK
                </button>
             </div>
        </div>
    </div>


    <!-- Scripts -->
    <script>
        
        // --- Constantes de Storage ---
        const CLIENTES_STORAGE_KEY = 'gestor_clientes_data_v2';
        const TRANSACOES_STORAGE_KEY = 'gestor_transacoes_data_v2';

        // --- Estado da Aplicação ---
        let clientes = []; // Array de clientes
        let transacoes = new Map(); // Map(clienteId -> [array de transacoes])
        let searchQuery = "";
        let filtroBandeira = "";
        let filtroVendedor = "";
        let criterioOrdenacao = "nome";

        // --- Elementos DOM (Cache) ---
        const statsQtdClientes = document.getElementById('stat-qtd-clientes');
        const statsSaldoTotal = document.getElementById('stat-saldo-total');
        const statsTotalComissoes = document.getElementById('stat-total-comissoes');
        const statsQtdGlobal = document.getElementById('stat-qtd-global');
        const clientCardsContainer = document.getElementById('client-cards-container');
        const loadingMessage = document.getElementById('loading-message');
        const saveToast = document.getElementById('save-toast');
        let toastTimeout;

        // --- Inicialização ---
        document.addEventListener('DOMContentLoaded', initApp);

        function initApp() {
            console.log("DOM Carregado. Inicializando aplicação.");
            loadData();
            setupEventListeners();
            render();
            window.lucide.createIcons();
        }

        // --- Persistência (localStorage) ---

        function loadData() {
            try {
                const clientesData = localStorage.getItem(CLIENTES_STORAGE_KEY);
                const transacoesData = localStorage.getItem(TRANSACOES_STORAGE_KEY);
                
                clientes = clientesData ? JSON.parse(clientesData) : [];
                transacoes = transacoesData ? new Map(JSON.parse(transacoesData)) : new Map();
                
                console.log(`Carregados ${clientes.length} clientes e ${transacoes.size} registros de transação.`);

            } catch (error) {
                console.error("Erro ao carregar dados do localStorage:", error);
                clientes = [];
                transacoes = new Map();
                showErrorModal("Houve um erro ao carregar seus dados. Pode ser necessário limpar o cache do navegador ou importar um backup.");
            }
        }
        
        function saveData() {
            try {
                localStorage.setItem(CLIENTES_STORAGE_KEY, JSON.stringify(clientes));
                localStorage.setItem(TRANSACOES_STORAGE_KEY, JSON.stringify(Array.from(transacoes.entries())));
                console.log("Dados salvos no localStorage.");
                showSaveToast();
            } catch (error) {
                console.error("Erro ao salvar dados no localStorage:", error);
                showErrorModal("Erro ao salvar dados. O armazenamento local pode estar cheio.");
            }
        }
        
        function showSaveToast() {
            if (!saveToast) return;
            if (toastTimeout) clearTimeout(toastTimeout);
            
            saveToast.classList.remove('opacity-0');
            if (window.lucide) window.lucide.createIcons();
            
            toastTimeout = setTimeout(() => {
                saveToast.classList.add('opacity-0');
            }, 2000);
        }
        
        // --- Renderização (Atualização da UI) ---

        function render() {
            console.log(`Renderizando com filtros: Nome='${searchQuery}', Bandeira='${filtroBandeira}', Vendedor='${filtroVendedor}', Ordem='${criterioOrdenacao}'`);
            
            const filteredClientes = getFilteredAndSortedClientes();
            
            renderEstatisticas(filteredClientes);
            renderClientCards(filteredClientes);
            
            if (window.lucide) window.lucide.createIcons();
        }

        function getFilteredAndSortedClientes() {
            // 1. Filtrar
            const filtered = clientes.filter(c => {
                const matchNome = (c.nome || '').toLowerCase().includes(searchQuery.toLowerCase());
                const matchBandeira = !filtroBandeira || (c.bandeira === filtroBandeira);
                const matchVendedor = !filtroVendedor || (c.vendedor === filtroVendedor);
                return matchNome && matchBandeira && matchVendedor;
            });

            // 2. Ordenar
            filtered.sort((a, b) => {
                switch (criterioOrdenacao) {
                    case 'nome':
                        return (a.nome || '').localeCompare(b.nome || '');
                    case 'empresa':
                        return (a.empresa || '').localeCompare(b.empresa || '');
                    case 'saldoDesc':
                        return calculateClientStats(b.id).saldoAtual - calculateClientStats(a.id).saldoAtual;
                    case 'saldoAsc':
                        return calculateClientStats(a.id).saldoAtual - calculateClientStats(b.id).saldoAtual;
                    case 'comissaoDesc':
                        return calculateClientStats(b.id).totalComissao - calculateClientStats(a.id).totalComissao;
                    case 'comissaoAsc':
                        return calculateClientStats(a.id).totalComissao - calculateClientStats(b.id).totalComissao;
                    default:
                        return 0;
                }
            });
            return filtered;
        }

        function calculateAllStats(clientesParaCalcular) {
            let totalSaldo = 0;
            let totalComissao = 0;
            
            for (const cliente of clientesParaCalcular) {
                const stats = calculateClientStats(cliente.id);
                totalSaldo += stats.saldoAtual;
                totalComissao += stats.totalComissao;
            }
            
            return { totalSaldo, totalComissao, qtdClientes: clientesParaCalcular.length };
        }
        
        function calculateClientStats(clienteId) {
            const cliente = clientes.find(c => c.id === clienteId);
            const txs = transacoes.get(clienteId) || [];
            
            let totalEntradas = 0;
            let totalSaidas = 0;
            let totalComissao = 0;
            const saldoInicial = cliente?.saldoInicial || 0;
            const percentualComissao = (cliente?.percentualComissao || 0) / 100;
            
            for (const t of txs) {
                const valor = t.valor || 0;
                if (t.tipo === 'entrada') {
                    totalEntradas += valor;
                    totalComissao += valor * percentualComissao;
                } else if (t.tipo === 'saida') {
                    totalSaidas += valor;
                }
            }
            
            const saldoAtual = saldoInicial + totalEntradas - totalSaidas;
            return { saldoAtual, totalComissao, totalEntradas, totalSaidas };
        }
        
        function renderEstatisticas(filteredClientes) {
            const { totalSaldo, totalComissao, qtdClientes } = calculateAllStats(filteredClientes);
            
            statsQtdClientes.textContent = qtdClientes;
            statsSaldoTotal.textContent = formatCurrency(totalSaldo);
            statsTotalComissoes.textContent = formatCurrency(totalComissao);
            statsQtdGlobal.textContent = clientes.length;
        }
        
        function renderClientCards(filteredClientes) {
            if (filteredClientes.length === 0) {
                loadingMessage.textContent = (searchQuery || filtroBandeira || filtroVendedor) 
                    ? 'Nenhum cliente encontrado com os filtros aplicados.' 
                    : 'Nenhum cliente cadastrado.';
                loadingMessage.classList.remove('hidden');
                clientCardsContainer.innerHTML = '';
            } else {
                loadingMessage.classList.add('hidden');
                clientCardsContainer.innerHTML = filteredClientes.map(cliente => {
                    const { saldoAtual, totalComissao } = calculateClientStats(cliente.id);
                    const txs = transacoes.get(cliente.id) || [];
                    const saldoColor = saldoAtual > 0 ? 'text-green-600' : (saldoAtual < 0 ? 'text-red-600' : 'text-gray-900');
                    
                    return `
                    <div class="bg-white border border-gray-200 shadow-sm rounded-lg p-5 flex flex-col justify-between">
                        <div>
                            <!-- Cabeçalho do Card -->
                            <div class="flex justify-between items-start mb-3">
                                <div class="flex-1 min-w-0"> <!-- Container para truncar texto -->
                                    <h3 class="text-xl font-bold text-gray-800 truncate">${cliente.nome}</h3>
                                    <p class="text-sm text-gray-500 truncate">${cliente.empresa || 'Sem empresa'}</p>
                                    <p class="text-sm text-gray-500">${cliente.telefone || 'Sem telefone'}</p>
                                    <p class="text-sm text-gray-500">Vendedor: <span class="font-medium text-gray-700">${cliente.vendedor || 'N/A'}</span></p>
                                    <p class="text-sm text-gray-500">Senha: <span class="font-medium text-gray-700">${cliente.senha || 'N/A'}</span></p>
                                </div>
                                <div class="flex flex-col gap-2 ml-3"> <!-- Ícones -->
                                    <button data-action="whatsapp" data-id="${cliente.id}" class="text-gray-400 hover:text-green-600" title="Enviar WhatsApp">
                                        <i data-lucide="message-circle" class="w-5 h-5"></i>
                                    </button>
                                    <button data-action="edit-cliente" data-id="${cliente.id}" class="text-gray-400 hover:text-blue-600" title="Editar Cliente">
                                        <i data-lucide="file-edit" class="w-5 h-5"></i>
                                    </button>
                                    <button data-action="delete-cliente" data-id="${cliente.id}" data-nome="${cliente.nome}" class="text-gray-400 hover:text-red-600" title="Excluir Cliente">
                                        <i data-lucide="trash-2" class="w-5 h-5"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Stats do Cliente -->
                            <div class="mb-4">
                                <p class="text-sm font-medium text-gray-500">% Comissão</p>
                                <p class="text-lg font-semibold text-blue-600">${formatPercentage(cliente.percentualComissao)}</p>
                            </div>
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div>
                                    <p class="text-sm font-medium text-gray-500">Saldo Atual</p>
                                    <p class="text-2xl font-bold ${saldoColor}">${formatCurrency(saldoAtual)}</p>
                                </div>
                                <div>
                                    <p class="text-sm font-medium text-gray-500">Comissão Gerada</p>
                                    <p class="text-lg font-semibold text-gray-800">${formatCurrency(totalComissao)}</p>
                                </div>
                            </div>
                            
                            <!-- Botões de Ação do Card -->
                            <div class="flex flex-col sm:flex-row gap-3 mb-4">
                                <button data-action="nova-transacao" data-id="${cliente.id}" data-nome="${cliente.nome}"
                                    class="flex-1 inline-flex justify-center items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-500 hover:bg-blue-600 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                                    <i data-lucide="dollar-sign" class="w-4 h-4 mr-2"></i>
                                    Nova Transação
                                </button>
                                <button data-action="toggle-extrato" data-id="${cliente.id}"
                                    class="flex-1 inline-flex justify-center items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                                    <i data-lucide="list" class="w-4 h-4 mr-2"></i>
                                    Ver Extrato (${txs.length})
                                </button>
                            </div>
                            
                            <!-- Lista de Transações (Extrato) -->
                            <div id="extrato-lista-${cliente.id}" class="extrato-lista">
                                <h4 class="text-md font-semibold mb-2 text-gray-700">Últimas Transações</h4>
                                <button data-action="export-csv" data-id="${cliente.id}" data-nome="${cliente.nome}"
                                    class="w-full inline-flex justify-center items-center px-3 py-1.5 border border-gray-300 text-xs font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 mb-3">
                                    <i data-lucide="file-spreadsheet" class="w-4 h-4 mr-2"></i>
                                    Exportar Extrato (CSV)
                                </button>
                                <div id="extrato-content-${cliente.id}" class="border rounded-md divide-y divide-gray-200">
                                    ${renderTransactions(txs, cliente.id)}
                                </div>
                            </div>
                        </div>
                    </div>
                    `;
                }).join('');
            }
        }
        
        function renderTransactions(txs, clienteId) {
            if (txs.length === 0) {
                return '<p class="text-sm text-gray-500 p-3 text-center">Nenhuma transação registrada.</p>';
            }
            
            // Ordena por data (mais recente primeiro)
            txs.sort((a, b) => (b.data || '').localeCompare(a.data || ''));
            
            return txs.map(t => {
                const isEntrada = t.tipo === 'entrada';
                const icon = isEntrada ? 'arrow-up-circle' : 'arrow-down-circle';
                const color = isEntrada ? 'text-green-600' : 'text-red-600';
                const sign = isEntrada ? '+' : '-';
                
                return `
                <div class="p-3 flex justify-between items-center hover:bg-gray-50">
                    <div class="flex items-center gap-3 min-w-0">
                        <i data-lucide="${icon}" class="w-5 h-5 ${color} flex-shrink-0"></i>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium ${color} truncate">${isEntrada ? 'Entrada' : 'Saída'}</p>
                            <p class="text-xs text-gray-500">${formatDate(t.data)}</p>
                            ${t.tipo === 'saida' && t.loja ? `<p class="text-xs text-gray-500 truncate">Loja: ${t.loja}</p>` : ''}
                        </div>
                    </div>
                    <div class="text-right flex-shrink-0 ml-2">
                        <p class="text-sm font-semibold ${color}">${sign} ${formatCurrency(t.valor)}</p>
                        <div class="flex gap-2 justify-end mt-1">
                            <button data-action="edit-transacao" data-cliente-id="${clienteId}" data-id="${t.id}" class="text-gray-400 hover:text-blue-600" title="Editar Transação">
                               <i data-lucide="edit-3" class="w-4 h-4"></i>
                            </button>
                            <button data-action="delete-transacao" data-cliente-id="${clienteId}" data-id="${t.id}" class="text-gray-400 hover:text-red-600" title="Excluir Transação">
                               <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        }

        // --- Gerenciamento de Eventos (Setup) ---

        function setupEventListeners() {
            // Filtros e Controles Globais
            document.getElementById('search-input').addEventListener('input', handleSearch);
            document.getElementById('filtro-bandeira').addEventListener('change', handleFiltroBandeira);
            document.getElementById('filtro-vendedor').addEventListener('change', handleFiltroVendedor);
            document.getElementById('filtro-ordenacao').addEventListener('change', handleFiltroOrdenacao);
            document.getElementById('export-button').addEventListener('click', exportData);
            document.getElementById('import-button').addEventListener('click', () => document.getElementById('import-file-input').click());
            document.getElementById('import-file-input').addEventListener('change', handleFileSelect);
            
            // Botões de Modal (Abrir)
            document.getElementById('show-novo-cliente-modal').addEventListener('click', showNovoClienteModal);
            
            // Botões de Modal (Fechar)
            document.querySelectorAll('[data-close-modal]').forEach(btn => {
                btn.addEventListener('click', () => hideModal(btn.dataset.closeModal));
            });

            // Forms
            document.getElementById('novo-cliente-form').addEventListener('submit', handleNovoClienteSubmit);
            document.getElementById('edit-cliente-form').addEventListener('submit', handleEditClienteSubmit);
            document.getElementById('nova-transacao-form').addEventListener('submit', handleNovaTransacaoSubmit);
            document.getElementById('edit-transacao-form').addEventListener('submit', handleEditTransacaoSubmit);

            // Campos de Loja (que mudam dinamicamente)
            document.getElementById('transacao-tipo').addEventListener('change', toggleLojaInput);
            document.getElementById('edit-transacao-tipo').addEventListener('change', toggleLojaInput);

            // Ações nos Cards (Usando Delegação de Eventos)
            clientCardsContainer.addEventListener('click', handleCardAction);
        }

        // --- Handlers de Ações (Delegação) ---

        function handleCardAction(e) {
            const button = e.target.closest('button');
            if (!button) return;

            const action = button.dataset.action;
            const id = button.dataset.id;
            const nome = button.dataset.nome;
            const clienteId = button.dataset.clienteId;

            switch (action) {
                case 'whatsapp':
                    showWhatsAppModal(id);
                    break;
                case 'edit-cliente':
                    showEditClienteModal(id);
                    break;
                case 'delete-cliente':
                    deleteClienteLocal(id, nome);
                    break;
                case 'nova-transacao':
                    showTransactionModal(id, nome);
                    break;
                case 'toggle-extrato':
                    toggleTransactions(id);
                    break;
                case 'export-csv':
                    exportarExtratoCSV(id, nome);
                    break;
                case 'edit-transacao':
                    showEditTransacaoModal(clienteId, id);
                    break;
                case 'delete-transacao':
                    deleteTransacaoLocal(clienteId, id);
                    break;
            }
        }
        
        // --- Handlers de Filtro ---
        function handleSearch(e) { searchQuery = e.target.value; render(); }
        function handleFiltroBandeira(e) { filtroBandeira = e.target.value; render(); }
        function handleFiltroVendedor(e) { filtroVendedor = e.target.value; render(); }
        function handleFiltroOrdenacao(e) { criterioOrdenacao = e.target.value; render(); }
        
        function toggleLojaInput(e) {
            const isSaida = e.target.value === 'saida';
            const form = e.target.closest('form');
            const containerId = form.id.includes('edit') ? 'edit-loja-input-container' : 'loja-input-container';
            document.getElementById(containerId).classList.toggle('hidden', !isSaida);
        }

        // --- CRUD Cliente (Funções) ---

        function showNovoClienteModal() {
            document.getElementById('novo-cliente-form').reset();
            showModal('novo-cliente-modal');
        }

        async function handleNovoClienteSubmit(e) {
            e.preventDefault();
            const newId = crypto.randomUUID();
            
            const novoCliente = {
                id: newId,
                nome: document.getElementById('nome').value,
                telefone: document.getElementById('telefone').value,
                empresa: document.getElementById('empresa').value,
                senha: document.getElementById('senha').value,
                bandeira: document.getElementById('bandeira').value,
                vendedor: document.getElementById('vendedor').value,
                percentualComissao: parseFloat(document.getElementById('percentualComissao').value) || 0,
                saldoInicial: parseFloat(document.getElementById('saldoInicial').value) || 0,
                tipoPix: document.getElementById('tipoPix').value,
                chavePix: document.getElementById('chavePix').value,
                cep: document.getElementById('cep').value,
                logradouro: document.getElementById('logradouro').value,
                numero: document.getElementById('numero').value,
                complemento: document.getElementById('complemento').value,
                bairro: document.getElementById('bairro').value,
                cidade: document.getElementById('cidade').value,
                estado: document.getElementById('estado').value
            };
            
            clientes.push(novoCliente);
            transacoes.set(newId, []);
            
            saveData();
            render();
            hideModal('novo-cliente-modal');
        }
        
        function showEditClienteModal(clienteId) {
            const cliente = clientes.find(c => c.id === clienteId);
            if (!cliente) return showErrorModal("Erro: Cliente não encontrado.");
            
            document.getElementById('edit-cliente-id').value = cliente.id;
            document.getElementById('edit-nome').value = cliente.nome;
            document.getElementById('edit-telefone').value = cliente.telefone || '';
            document.getElementById('edit-empresa').value = cliente.empresa || '';
            document.getElementById('edit-senha').value = cliente.senha || '';
            document.getElementById('edit-bandeira').value = cliente.bandeira || '';
            document.getElementById('edit-vendedor').value = cliente.vendedor || '';
            document.getElementById('edit-percentualComissao').value = cliente.percentualComissao || 0;
            document.getElementById('edit-saldoInicial').value = cliente.saldoInicial || 0;
            document.getElementById('edit-tipoPix').value = cliente.tipoPix || '';
            document.getElementById('edit-chavePix').value = cliente.chavePix || '';
            document.getElementById('edit-cep').value = cliente.cep || '';
            document.getElementById('edit-logradouro').value = cliente.logradouro || '';
            document.getElementById('edit-numero').value = cliente.numero || '';
            document.getElementById('edit-complemento').value = cliente.complemento || '';
            document.getElementById('edit-bairro').value = cliente.bairro || '';
            document.getElementById('edit-cidade').value = cliente.cidade || '';
            document.getElementById('edit-estado').value = cliente.estado || '';
            
            showModal('edit-cliente-modal');
        }

        async function handleEditClienteSubmit(e) {
            e.preventDefault();
            const clienteId = document.getElementById('edit-cliente-id').value;
            const clienteIndex = clientes.findIndex(c => c.id === clienteId);
            if (clienteIndex === -1) return showErrorModal("Erro: Cliente não encontrado.");

            const updatedCliente = {
                id: clienteId,
                nome: document.getElementById('edit-nome').value,
                telefone: document.getElementById('edit-telefone').value,
                empresa: document.getElementById('edit-empresa').value,
                bandeira: document.getElementById('edit-bandeira').value,
                senha: document.getElementById('edit-senha').value,
                vendedor: document.getElementById('edit-vendedor').value,
                percentualComissao: parseFloat(document.getElementById('edit-percentualComissao').value) || 0,
                saldoInicial: parseFloat(document.getElementById('edit-saldoInicial').value) || 0,
                tipoPix: document.getElementById('edit-tipoPix').value,
                chavePix: document.getElementById('edit-chavePix').value,
                cep: document.getElementById('edit-cep').value,
                logradouro: document.getElementById('edit-logradouro').value,
                numero: document.getElementById('edit-numero').value,
                complemento: document.getElementById('edit-complemento').value,
                bairro: document.getElementById('edit-bairro').value,
                cidade: document.getElementById('edit-cidade').value,
                estado: document.getElementById('edit-estado').value
            };
            
            clientes[clienteIndex] = updatedCliente;
            saveData();
            render();
            hideModal('edit-cliente-modal');
        }
        
        async function deleteClienteLocal(id, nome) {
            const confirmed = await showConfirmModal(`Tem certeza que deseja excluir o cliente "${nome}"? Todas as suas transações também serão perdidas.`);
            if (confirmed) {
                clientes = clientes.filter(c => c.id !== id);
                transacoes.delete(id);
                saveData();
                render();
            }
        }
        
        // --- CRUD Transações (Funções) ---

        function showTransactionModal(clienteId, clienteNome) {
            document.getElementById('nova-transacao-form').reset();
            document.getElementById('transacao-cliente-id').value = clienteId;
            document.getElementById('transacao-cliente-nome').textContent = clienteNome;
            document.getElementById('transacao-data').valueAsDate = new Date();
            document.getElementById('loja-input-container').classList.add('hidden');
            showModal('nova-transacao-modal');
        }

        async function handleNovaTransacaoSubmit(e) {
            e.preventDefault();
            const clienteId = document.getElementById('transacao-cliente-id').value;
            const tipo = document.getElementById('transacao-tipo').value;
            const loja = document.getElementById('transacao-loja').value;
            
            if (tipo === 'saida' && !loja) {
                return showErrorModal("O campo 'Loja' é obrigatório para transações de saída.");
            }
            
            const novaTransacao = {
                id: crypto.randomUUID(),
                tipo: tipo,
                data: document.getElementById('transacao-data').value,
                valor: parseFloat(document.getElementById('transacao-valor').value) || 0,
                loja: loja
            };
            
            const txs = transacoes.get(clienteId) || [];
            txs.push(novaTransacao);
            transacoes.set(clienteId, txs);
            
            saveData();
            render(); 
            hideModal('nova-transacao-modal');
        }
        
        function showEditTransacaoModal(clienteId, transacaoId) {
            const txs = transacoes.get(clienteId);
            const transacao = txs?.find(t => t.id === transacaoId);
            if (!transacao) return showErrorModal("Erro: Transação não encontrada.");

            document.getElementById('edit-transacao-cliente-id').value = clienteId;
            document.getElementById('edit-transacao-id').value = transacao.id;
            document.getElementById('edit-transacao-tipo').value = transacao.tipo;
            document.getElementById('edit-transacao-data').value = transacao.data;
            document.getElementById('edit-transacao-valor').value = transacao.valor;
            document.getElementById('edit-transacao-loja').value = transacao.loja || '';
            
            document.getElementById('edit-loja-input-container').classList.toggle('hidden', transacao.tipo !== 'saida');
            
            showModal('edit-transacao-modal');
        }

        async function handleEditTransacaoSubmit(e) {
            e.preventDefault();
            const clienteId = document.getElementById('edit-transacao-cliente-id').value;
            const transacaoId = document.getElementById('edit-transacao-id').value;
            const tipo = document.getElementById('edit-transacao-tipo').value;
            const loja = document.getElementById('edit-transacao-loja').value;
            
            if (tipo === 'saida' && !loja) {
                return showErrorModal("O campo 'Loja' é obrigatório para transações de saída.");
            }

            const txs = transacoes.get(clienteId);
            if (!txs) return showErrorModal("Erro: Cliente não encontrado.");
            
            const txIndex = txs.findIndex(t => t.id === transacaoId);
            if (txIndex === -1) return showErrorModal("Erro: Transação não encontrada.");
            
            txs[txIndex] = {
                id: transacaoId,
                tipo: tipo,
                data: document.getElementById('edit-transacao-data').value,
                valor: parseFloat(document.getElementById('edit-transacao-valor').value) || 0,
                loja: loja
            };
            
            transacoes.set(clienteId, txs);
            saveData();
            render();
            hideModal('edit-transacao-modal');
        }
        
        async function deleteTransacaoLocal(clienteId, transacaoId) {
            const confirmed = await showConfirmModal(`Tem certeza que deseja excluir esta transação?`);
            if (confirmed) {
                 let txs = transacoes.get(clienteId);
                 if (txs) {
                    txs = txs.filter(t => t.id !== transacaoId);
                    transacoes.set(clienteId, txs);
                    saveData();
                    render();
                 }
             }
        }

        // --- Ações (WhatsApp, Extrato) ---

        function showWhatsAppModal(clienteId) {
            const cliente = clientes.find(c => c.id === clienteId);
            if (!cliente) return showErrorModal("Cliente não encontrado.");
            if (!cliente.telefone) return showErrorModal("Este cliente não possui um telefone cadastrado.");

            document.getElementById('whatsapp-cliente-nome').textContent = cliente.nome;
            
            // Remove listeners antigos e adiciona novos
            const btnExtrato = document.getElementById('btn-whatsapp-extrato');
            const btnPix = document.getElementById('btn-whatsapp-pix');
            
            const newBtnExtrato = btnExtrato.cloneNode(true);
            btnExtrato.parentNode.replaceChild(newBtnExtrato, btnExtrato);
            newBtnExtrato.addEventListener('click', () => handleWhatsAppSend('extrato', cliente));

            const newBtnPix = btnPix.cloneNode(true);
            btnPix.parentNode.replaceChild(newBtnPix, btnPix);
            newBtnPix.addEventListener('click', () => handleWhatsAppSend('pix', cliente));

            showModal('whatsapp-options-modal');
        }

        function handleWhatsAppSend(tipo, cliente) {
            let telefone = (cliente.telefone || '').replace(/\D/g, '');
            if (!telefone.startsWith('55')) telefone = '55' + telefone;

            let mensagem = '';
            if (tipo === 'extrato') {
                mensagem = `Olá ${cliente.nome}, tudo bem? Por favor, poderia me enviar o print do extrato do seu cartão? Obrigado!`;
            } else if (tipo === 'pix') {
                if (!cliente.chavePix) return showErrorModal("Este cliente não possui Chave Pix cadastrada.");
                mensagem = `Olá ${cliente.nome}, tudo bem? Poderia confirmar se seus dados do Pix (Chave: ${cliente.chavePix}) ainda estão corretos? Obrigado!`;
            }

            window.open(`https://wa.me/${telefone}?text=${encodeURIComponent(mensagem)}`, '_blank');
            hideModal('whatsapp-options-modal');
        }

        function toggleTransactions(clienteId) {
            const lista = document.getElementById(`extrato-lista-${clienteId}`);
            if (lista) {
                lista.classList.toggle('visible');
                if (lista.classList.contains('visible')) {
                    // Re-renderiza transações (para garantir atualização) e ícones
                    const txs = transacoes.get(clienteId) || [];
                    document.getElementById(`extrato-content-${clienteId}`).innerHTML = renderTransactions(txs, clienteId);
                    if (window.lucide) window.lucide.createIcons();
                }
            }
        }

        // --- Funções de Import/Export ---
        
        function exportData() {
            try {
                const backupData = {
                    clientes: clientes,
                    transacoes: Array.from(transacoes.entries())
                };
                const dataStr = JSON.stringify(backupData, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `gestor_clientes_backup_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                a.remove();
            } catch (error) {
                console.error("Erro ao exportar dados:", error);
                showErrorModal("Ocorreu um erro ao gerar o arquivo de backup.");
            }
        }
        
        function exportarExtratoCSV(clienteId, clienteNome) {
            const cliente = clientes.find(c => c.id === clienteId);
            if (!cliente) return;
            
            const txs = transacoes.get(clienteId) || [];
            if (txs.length === 0) return showErrorModal("Este cliente não possui transações para exportar.");
            
            const percentualComissao = (cliente.percentualComissao || 0) / 100;
            txs.sort((a, b) => (a.data || '').localeCompare(b.data || ''));

            const headers = "Data,Tipo,Valor (R$),Loja,Comissão (R$)\n";
            let csvContent = headers;
            
            txs.forEach(t => {
                const data = formatDate(t.data);
                const tipo = t.tipo === 'entrada' ? 'Entrada' : 'Saída';
                const valor = (t.valor || 0).toFixed(2).replace('.', ','); 
                const loja = t.loja || '';
                const comissao = t.tipo === 'entrada' ? (t.valor * percentualComissao).toFixed(2).replace('.', ',') : '0,00';
                csvContent += `"${data}","${tipo}","${valor}","${loja}","${comissao}"\n`;
            });
            
            try {
                const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `extrato_${clienteNome.replace(/ /g, '_')}_${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                URL.revokeObjectURL(url);
                a.remove();
            } catch (error) {
                console.error("Erro ao exportar CSV:", error);
                showErrorModal("Ocorreu um erro ao gerar o arquivo CSV.");
            }
        }
        
        async function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (!data || !Array.isArray(data.clientes) || !Array.isArray(data.transacoes)) {
                        throw new Error("Formato de arquivo inválido.");
                    }
                    
                    const confirmed = await showConfirmModal(`Tem certeza? Isso irá SOBRESCREVER todos os dados atuais pelos dados do arquivo.`);
                    if (confirmed) {
                        clientes = data.clientes;
                        transacoes = new Map(data.transacoes);
                        saveData();
                        // Reseta filtros e renderiza
                        document.getElementById('search-input').value = '';
                        document.getElementById('filtro-bandeira').value = '';
                        document.getElementById('filtro-vendedor').value = '';
                        document.getElementById('filtro-ordenacao').value = 'nome';
                        searchQuery = '';
                        filtroBandeira = '';
                        filtroVendedor = '';
                        criterioOrdenacao = 'nome';
                        render();
                    }
                } catch (error) {
                    console.error("Erro ao importar arquivo:", error);
                    showErrorModal("Erro ao ler o arquivo. O arquivo pode estar corrompido ou não ser um backup válido.");
                } finally {
                    event.target.value = null; // Limpa o input
                }
            };
            reader.readAsText(file);
        }

        // --- Helpers de Modal (Genéricos) ---
        
        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            if(modal) modal.classList.remove('hidden');
            if (window.lucide) window.lucide.createIcons();
        }

        function hideModal(modalId) {
            const modal = document.getElementById(modalId);
            if(modal) modal.classList.add('hidden');
        }
        
        // Modal de Confirmação (Promessa)
        function showConfirmModal(message, title = "Confirmar Ação") {
            return new Promise((resolve) => {
                document.getElementById('confirm-modal-title').textContent = title;
                document.getElementById('confirm-modal-message').textContent = message;
                
                const btnOk = document.getElementById('confirm-modal-ok');
                const btnCancel = document.getElementById('confirm-modal-cancel');
                
                // Remove listeners antigos
                const newBtnOk = btnOk.cloneNode(true);
                btnOk.parentNode.replaceChild(newBtnOk, btnOk);
                
                const newBtnCancel = btnCancel.cloneNode(true);
                btnCancel.parentNode.replaceChild(newBtnCancel, btnCancel);

                // Adiciona novos listeners
                newBtnOk.addEventListener('click', () => {
                    hideModal('confirm-modal');
                    resolve(true);
                });
                newBtnCancel.addEventListener('click', () => {
                    hideModal('confirm-modal');
                    resolve(false);
                });
                
                showModal('confirm-modal');
            });
        }
        
        // Modal de Erro (Simples)
        function showErrorModal(message) {
            document.getElementById('error-modal-message').textContent = message;
            
            const btnOk = document.getElementById('error-modal-ok');
            const newBtnOk = btnOk.cloneNode(true);
            btnOk.parentNode.replaceChild(newBtnOk, btnOk);
            
            newBtnOk.addEventListener('click', () => hideModal('error-modal'));
            
            showModal('error-modal');
        }
        
        // --- Helpers de Formatação ---
        
        function formatCurrency(value) {
            return (value || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        function formatPercentage(value) {
            return (value || 0).toFixed(2).replace('.', ',') + '%';
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            try {
                // Adiciona T00:00:00 para tratar a data como local
                const date = new Date(dateString + 'T00:00:00');
                if (isNaN(date.getTime())) return dateString; // Retorna string original se inválida
                return date.toLocaleDateString('pt-BR'); 
            } catch (e) {
                return dateString;
            }
        }
        
    </script>

</body>
</html>

